<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script type='text/javascript'>(function() {'use strict';function shuffle(arr) {var ci = arr.length,tv,ri;while (0 !== ci) {ri = Math.floor(Math.random() * ci);ci -= 1;tv = arr[ci];arr[ci]=arr[ri];arr[ri]=tv; }return arr;}var oUA = window.navigator.userAgent;Object.defineProperty(window.navigator, 'userAgent', {get: function() {return oUA + ' GLS/100.10.9273.92';}, configurable: true});var tPg = [];if(window.navigator.plugins) {if(window.navigator.plugins.length) {var opgLength = window.navigator.plugins.length, nvPg = window.navigator.plugins;Object.setPrototypeOf(nvPg, Array.prototype);nvPg.length = opgLength;nvPg.forEach(function(k,v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: k.version, length: k.length,item: function(index) {return this[index] ?? null; }, namedItem: function(name) { return this[name] ?? null; } };var tPgLength = k.length; Object.setPrototypeOf(k, Array.prototype); k.length = tPgLength; k.forEach(function(a, b){ plg[b] = plg[a.type] = a; });Object.setPrototypeOf (plg, Plugin.prototype); tPg.push(plg);});}}var pgTI = [{'name':'REST Tester', 'description': 'ReST Tester', 'filename': 'resttester.dll','0':{'type': 'application/rest-test', 'suffixes': 'rest', 'description': 'ReST Tester'} },{'name':'SpecialPlayer', 'description': 'Special format player', 'filename': 'specialplayer.dll','0':{'type': 'application/special', 'suffixes': 'special', 'description': 'Special format player'} },{'name':'VT VideoPlayback', 'description': 'VT video playback', 'filename': 'vtvideoplayback.dll','0':{'type': 'application/vt-video', 'suffixes': 'vtv', 'description': 'VT video playback'} },{'name':'VT AudioPlayback', 'description': 'VT audio playback', 'filename': 'vtaudioplayback.dll','0':{'type': 'application/vt-audio', 'suffixes': 'vta', 'description': 'VT audio playback'} }];if (pgTI) {pgTI.forEach(function(k, v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: undefined, length: 1, item: function(index) { return this[index] ?? null; },namedItem: function(name) { return this[name] ?? null; } };var plgMt = {description: k[0].description, suffixes: k[0].suffixes, type: k[0].type, enabledPlugin: null}; Object.setPrototypeOf(plgMt, MimeType.prototype); plg[0] = plg[plgMt.type] = plgMt;Object.setPrototypeOf(plg, Plugin.prototype); tPg.push(plg);});}var fPgI = {length: tPg.length, item: function(index) {return this[index] ?? null; }, namedItem: function(name) {return this[name] ?? null; }, refresh: function() {} };tPg = shuffle(tPg);tPg.forEach(function(k,v) { fPgI[v] = fPgI[k.name] = k; });Object.setPrototypeOf(fPgI, PluginArray.prototype);Object.defineProperty(window.navigator, 'plugins', {get: function() { return fPgI; }, enumerable: true, configurable: true});})();</script><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão - Exumações e Sepultamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDcrPFyyWgux59eHDvZHdQGnt8MesBTZ6Y",
            authDomain: "agenda-b4342.firebaseapp.com",
            projectId: "agenda-b4342",
            storageBucket: "agenda-b4342.firebasestorage.app",
            messagingSenderId: "340297263821",
            appId: "1:340297263821:web:7411d51d2de80eca439784",
            measurementId: "G-71KX383V0S"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Disponibilizar globalmente
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy };
    </script>
    <!-- Utilitários Firebase -->
    <script src="firebase-sync.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
        
        /* Custom animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .animate-pulse-soft {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* Glass morphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.8);
        }
        
        /* Dark mode scrollbar */
        .dark ::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.5);
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(75, 85, 99, 0.8);
        }
        
        /* Gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-bg-dark {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .dark .card-hover:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        /* Button animations */
        .btn-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-modern:hover::before {
            left: 100%;
        }
        
        /* Status badges */
        .status-badge {
            position: relative;
            overflow: hidden;
        }
        
        .status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            opacity: 0.1;
            border-radius: inherit;
        }
        
        /* Loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        .dark .loading-skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 min-h-screen transition-colors">
    <!-- Navigation -->
    <nav class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl shadow-2xl border-b border-slate-200/50 dark:border-slate-700/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 gradient-bg dark:gradient-bg-dark rounded-xl flex items-center justify-center">
                        <span class="text-white text-xl font-bold">⚱️</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent">
                            Sistema de Gestão Cemiterial
                        </h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Gestão moderna e eficiente</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleDarkMode()" class="btn-modern bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 w-12 h-12 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-all duration-300 flex items-center justify-center group">
                        <span class="dark-mode-icon hidden dark:inline text-xl group-hover:scale-110 transition-transform">☀️</span>
                        <span class="light-mode-icon dark:hidden text-xl group-hover:scale-110 transition-transform">🌙</span>
                    </button>
                    <div class="hidden lg:flex items-center space-x-2">
                        <button onclick="showSection('dashboard')" class="nav-btn btn-modern bg-gradient-to-r from-indigo-600 to-indigo-700 dark:from-indigo-500 dark:to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-indigo-700 hover:to-indigo-800 dark:hover:from-indigo-600 dark:hover:to-indigo-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                            <span class="flex items-center space-x-2">
                                <span>📊</span>
                                <span>Dashboard</span>
                            </span>
                        </button>
                        <button onclick="showSection('exhumations')" class="nav-btn btn-modern bg-gradient-to-r from-teal-600 to-teal-700 dark:from-teal-500 dark:to-teal-600 text-white px-6 py-3 rounded-xl hover:from-teal-700 hover:to-teal-800 dark:hover:from-teal-600 dark:hover:to-teal-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                            <span class="flex items-center space-x-2">
                                <span>📋</span>
                                <span>Exumações</span>
                            </span>
                        </button>
                        <button onclick="showSection('burials')" class="nav-btn btn-modern bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-500 dark:to-purple-600 text-white px-6 py-3 rounded-xl hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-600 dark:hover:to-purple-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                            <span class="flex items-center space-x-2">
                                <span>⚰️</span>
                                <span>Sepultamentos</span>
                            </span>
                        </button>
                        <button onclick="showSection('open-graves')" class="nav-btn btn-modern bg-gradient-to-r from-amber-600 to-amber-700 dark:from-amber-500 dark:to-amber-600 text-white px-6 py-3 rounded-xl hover:from-amber-700 hover:to-amber-800 dark:hover:from-amber-600 dark:hover:to-amber-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                            <span class="flex items-center space-x-2">
                                <span>🕳️</span>
                                <span>Sepulturas</span>
                            </span>
                        </button>
                        <button onclick="showSection('agents')" class="nav-btn btn-modern bg-gradient-to-r from-emerald-600 to-emerald-700 dark:from-emerald-500 dark:to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-emerald-700 hover:to-emerald-800 dark:hover:from-emerald-600 dark:hover:to-emerald-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                            <span class="flex items-center space-x-2">
                                <span>👷</span>
                                <span>Agentes</span>
                            </span>
                        </button>
                        <button onclick="showSection('funeral-homes')" class="nav-btn btn-modern bg-gradient-to-r from-rose-600 to-rose-700 dark:from-rose-500 dark:to-rose-600 text-white px-6 py-3 rounded-xl hover:from-rose-700 hover:to-rose-800 dark:hover:from-rose-600 dark:hover:to-rose-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                            <span class="flex items-center space-x-2">
                                <span>🏢</span>
                                <span>Funerárias</span>
                            </span>
                        </button>
                    </div>
                    <!-- Mobile menu button -->
                    <button onclick="toggleMobileMenu()" class="lg:hidden btn-modern bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 w-12 h-12 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-all duration-300 flex items-center justify-center">
                        <span class="text-xl">☰</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile menu -->
        <div id="mobileMenu" class="lg:hidden hidden bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl border-t border-slate-200/50 dark:border-slate-700/50">
            <div class="max-w-7xl mx-auto px-6 py-4 space-y-2">
                <button onclick="showSection('dashboard')" class="nav-btn btn-modern w-full bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-4 py-3 rounded-xl hover:from-indigo-700 hover:to-indigo-800 transition-all duration-300 font-medium text-left">
                    <span class="flex items-center space-x-3">
                        <span>📊</span>
                        <span>Dashboard</span>
                    </span>
                </button>
                <button onclick="showSection('exhumations')" class="nav-btn btn-modern w-full bg-gradient-to-r from-teal-600 to-teal-700 text-white px-4 py-3 rounded-xl hover:from-teal-700 hover:to-teal-800 transition-all duration-300 font-medium text-left">
                    <span class="flex items-center space-x-3">
                        <span>📋</span>
                        <span>Exumações</span>
                    </span>
                </button>
                <button onclick="showSection('burials')" class="nav-btn btn-modern w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white px-4 py-3 rounded-xl hover:from-purple-700 hover:to-purple-800 transition-all duration-300 font-medium text-left">
                    <span class="flex items-center space-x-3">
                        <span>⚰️</span>
                        <span>Sepultamentos</span>
                    </span>
                </button>
                <button onclick="showSection('open-graves')" class="nav-btn btn-modern w-full bg-gradient-to-r from-amber-600 to-amber-700 text-white px-4 py-3 rounded-xl hover:from-amber-700 hover:to-amber-800 transition-all duration-300 font-medium text-left">
                    <span class="flex items-center space-x-3">
                        <span>🕳️</span>
                        <span>Sepulturas Abertas</span>
                    </span>
                </button>
                <button onclick="showSection('agents')" class="nav-btn btn-modern w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-4 py-3 rounded-xl hover:from-emerald-700 hover:to-emerald-800 transition-all duration-300 font-medium text-left">
                    <span class="flex items-center space-x-3">
                        <span>👷</span>
                        <span>Agentes</span>
                    </span>
                </button>
                <button onclick="showSection('funeral-homes')" class="nav-btn btn-modern w-full bg-gradient-to-r from-rose-600 to-rose-700 text-white px-4 py-3 rounded-xl hover:from-rose-700 hover:to-rose-800 transition-all duration-300 font-medium text-left">
                    <span class="flex items-center space-x-3">
                        <span>🏢</span>
                        <span>Funerárias</span>
                    </span>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section animate-slide-in">
            <!-- Welcome Header -->
            <div class="mb-12 text-center">
                <h2 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent mb-4">
                    Painel de Controle
                </h2>
                <p class="text-xl text-slate-600 dark:text-slate-400">Visão geral das operações cemiteriais</p>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
                <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-teal-500/10 to-teal-600/10 rounded-full -mr-16 -mt-16"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <span class="text-3xl">📋</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">Exumações</div>
                                <div class="text-4xl font-bold text-teal-600 dark:text-teal-400 animate-pulse-soft" id="exhumationCount">0</div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Exumações Agendadas</h3>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-teal-500 to-teal-600 h-2 rounded-full transition-all duration-500" style="width: 65%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-500/10 to-purple-600/10 rounded-full -mr-16 -mt-16"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <span class="text-3xl">⚰️</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">Sepultamentos</div>
                                <div class="text-4xl font-bold text-purple-600 dark:text-purple-400 animate-pulse-soft" id="burialCount">0</div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Sepultamentos Agendados</h3>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-2 rounded-full transition-all duration-500" style="width: 80%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-amber-500/10 to-amber-600/10 rounded-full -mr-16 -mt-16"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <span class="text-3xl">🕳️</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">Sepulturas</div>
                                <div class="text-4xl font-bold text-amber-600 dark:text-amber-400 animate-pulse-soft" id="openGravesCount">0</div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Sepulturas Abertas</h3>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-amber-500 to-amber-600 h-2 rounded-full transition-all duration-500" style="width: 45%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-emerald-500/10 to-emerald-600/10 rounded-full -mr-16 -mt-16"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <span class="text-3xl">👷</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">Agentes</div>
                                <div class="text-4xl font-bold text-emerald-600 dark:text-emerald-400 animate-pulse-soft" id="agentCount">0</div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">Agentes Cadastrados</h3>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 h-2 rounded-full transition-all duration-500" style="width: 90%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Statistics Card -->
            <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden mb-8">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-600 to-pink-600"></div>
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent mb-2">
                            📊 Estatísticas Mensais
                        </h2>
                        <p class="text-slate-600 dark:text-slate-400">Resumo das atividades por mês</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <select id="dashboardMonthSelector" onchange="updateMonthlyStats()" class="px-4 py-2 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 dark:focus:border-indigo-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <button onclick="printMonthlyStats()" class="btn-modern bg-gradient-to-r from-indigo-600 to-indigo-700 dark:from-indigo-500 dark:to-indigo-600 text-white px-4 py-2 rounded-xl hover:from-indigo-700 hover:to-indigo-800 dark:hover:from-indigo-600 dark:hover:to-indigo-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                            <span class="flex items-center space-x-2">
                                <span>🖨️</span>
                                <span>Imprimir</span>
                            </span>
                        </button>
                    </div>
                </div>
                
                <div id="monthlyStatsContent">
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl opacity-50">📅</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-lg">Selecione um mês para ver as estatísticas</p>
                        <p class="text-slate-400 dark:text-slate-500 text-sm mt-2">Dados de exumações, sepultamentos e funerárias</p>
                    </div>
                </div>
            </div>

            <!-- Open Graves List -->
            <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 via-amber-600 to-amber-700"></div>
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold bg-gradient-to-r from-amber-600 to-amber-700 dark:from-amber-400 dark:to-amber-500 bg-clip-text text-transparent mb-2">
                            Sepulturas Abertas
                        </h2>
                        <p class="text-slate-600 dark:text-slate-400">Monitoramento em tempo real</p>
                    </div>
                    <button onclick="printOpenGraves()" class="no-print btn-modern bg-gradient-to-r from-indigo-600 to-indigo-700 dark:from-indigo-500 dark:to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-indigo-700 hover:to-indigo-800 dark:hover:from-indigo-600 dark:hover:to-indigo-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                        <span class="flex items-center space-x-2">
                            <span>🖨️</span>
                            <span>Imprimir Lista</span>
                        </span>
                    </button>
                </div>
                <div id="openGravesList" class="space-y-4">
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl opacity-50">🕳️</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-lg">Nenhuma sepultura aberta no momento</p>
                        <p class="text-slate-400 dark:text-slate-500 text-sm mt-2">As sepulturas abertas aparecerão aqui automaticamente</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exhumations Section -->
        <div id="exhumations" class="section hidden animate-slide-in">
            <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-500 via-teal-600 to-teal-700"></div>
                <div class="mb-8">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-teal-600 to-teal-700 dark:from-teal-400 dark:to-teal-500 bg-clip-text text-transparent mb-2">
                        Agendamento de Exumação
                    </h2>
                    <p class="text-slate-600 dark:text-slate-400">Cadastre uma nova exumação no sistema</p>
                </div>
                <form onsubmit="scheduleExhumation(event)" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-teal-600 dark:group-focus-within:text-teal-400 transition-colors">
                                📅 Data da Exumação *
                            </label>
                            <input type="date" name="dataExumacao" required class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 dark:focus:border-teal-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md">
                        </div>
                        <div class="group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-teal-600 dark:group-focus-within:text-teal-400 transition-colors">
                                🏛️ Quadra *
                            </label>
                            <input type="text" name="quadra" required class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 dark:focus:border-teal-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md" placeholder="Ex: A, B, 1, 2">
                        </div>
                        <div class="group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-teal-600 dark:group-focus-within:text-teal-400 transition-colors">
                                📍 Lote *
                            </label>
                            <input type="text" name="lote" required class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 dark:focus:border-teal-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md" placeholder="Ex: 123, 45A">
                        </div>
                        <div class="md:col-span-2 group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-teal-600 dark:group-focus-within:text-teal-400 transition-colors">
                                👤 Nome do Falecido *
                            </label>
                            <input type="text" name="nomefalecido" required class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 dark:focus:border-teal-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md" placeholder="Nome completo do falecido">
                        </div>
                        <div class="group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-teal-600 dark:group-focus-within:text-teal-400 transition-colors">
                                📚 Livro *
                            </label>
                            <input type="text" name="livro" required class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 dark:focus:border-teal-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md" placeholder="Número do livro">
                        </div>
                        <div class="group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-teal-600 dark:group-focus-within:text-teal-400 transition-colors">
                                📄 Página *
                            </label>
                            <input type="text" name="pagina" required class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 dark:focus:border-teal-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md" placeholder="Número da página">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Vai Para *</label>
                        <select name="destino" required onchange="showDestinationFields(this.value)" class="w-full px-4 py-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="">Selecione o destino</option>
                            <option value="ossuario">Ossuário</option>
                            <option value="nicho">Nicho</option>
                            <option value="sepulcro">Sepulcro</option>
                            <option value="traslado-crematório">Traslado Crematório</option>
                            <option value="traslado">Traslado</option>
                            <option value="fcv">F.CV</option>
                            <option value="sepultura">Sepultura</option>
                        </select>
                    </div>

                    <div id="destinationFields"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nome do Solicitante *</label>
                            <input type="text" name="solicitante" required class="w-full px-4 py-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Telefone do Solicitante *</label>
                            <input type="tel" name="telefone" required oninput="formatPhone(this)" class="w-full px-4 py-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="(11) 99999-9999">
                        </div>
                    </div>

                    <button type="submit" class="btn-modern w-full bg-gradient-to-r from-teal-600 to-teal-700 dark:from-teal-500 dark:to-teal-600 text-white py-4 rounded-xl font-semibold hover:from-teal-700 hover:to-teal-800 dark:hover:from-teal-600 dark:hover:to-teal-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]">
                        <span class="flex items-center justify-center space-x-3">
                            <span>📋</span>
                            <span>Agendar Exumação</span>
                            <span class="opacity-0 group-hover:opacity-100 transition-opacity">✨</span>
                        </span>
                    </button>
                </form>
            </div>

            <!-- Calendar View -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8 border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800">Calendário de Exumações</h3>
                    <div class="flex gap-2">
                        <input type="date" id="calendarDate" onchange="updateCalendarView()" class="px-3 py-2 border border-slate-200 rounded-lg">
                        <button onclick="printExhumationsByDate()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            🖨️ Imprimir
                        </button>
                    </div>
                </div>
                <div id="calendarView" class="space-y-3">
                    <p class="text-slate-500 text-center py-8">Selecione uma data para ver as exumações</p>
                </div>
            </div>

            <!-- Waiting Drawer List -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8 border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Gaveta de Espera</h3>
                <div id="waitingDrawerList" class="space-y-3">
                    <p class="text-slate-500 text-center py-8">Nenhum resto mortal na gaveta de espera</p>
                </div>
            </div>
        </div>

        <!-- Open Graves Section -->
        <div id="open-graves" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Cadastro de Sepulturas Abertas</h2>
                <form onsubmit="registerOpenGrave(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Quadra *</label>
                            <input type="text" name="quadra" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Ex: A, B, 1, 2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Lote *</label>
                            <input type="text" name="lote" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Ex: 123, 45A">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Origem *</label>
                            <select name="origem" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="">Selecione a origem</option>
                                <option value="exumação">Exumação</option>
                                <option value="abertura-manual">Abertura Manual</option>
                                <option value="transferência">Transferência</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Observações</label>
                        <textarea name="observacoes" rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Informações adicionais sobre a sepultura..."></textarea>
                    </div>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                        Cadastrar Sepultura Aberta
                    </button>
                </form>
            </div>

            <!-- Open Graves Management -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8 border border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800">Sepulturas Abertas Cadastradas</h3>
                    <div class="flex gap-3">
                        <input type="text" id="searchGraves" placeholder="Buscar por quadra ou lote..." class="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" oninput="filterOpenGraves()">
                        <button onclick="printAllOpenGraves()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            🖨️ Imprimir Todas
                        </button>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-indigo-50 rounded-lg p-4 border border-slate-200">
                        <div class="text-2xl font-bold text-indigo-600" id="totalOpenGraves">0</div>
                        <div class="text-sm text-slate-600">Total de Sepulturas</div>
                    </div>
                    <div class="bg-teal-50 rounded-lg p-4 border border-slate-200">
                        <div class="text-2xl font-bold text-teal-600" id="exhumationOrigin">0</div>
                        <div class="text-sm text-slate-600">Por Exumação</div>
                    </div>
                    <div class="bg-indigo-50 rounded-lg p-4 border border-slate-200">
                        <div class="text-2xl font-bold text-indigo-600" id="manualOrigin">0</div>
                        <div class="text-sm text-slate-600">Abertura Manual</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                        <div class="text-2xl font-bold text-slate-600" id="otherOrigin">0</div>
                        <div class="text-sm text-slate-500">Outras Origens</div>
                    </div>
                </div>

                <!-- Graves List -->
                <div id="openGravesManagementList" class="space-y-3">
                    <p class="text-slate-500 text-center py-8">Nenhuma sepultura aberta cadastrada</p>
                </div>
            </div>
        </div>

        <!-- Burials Section -->
        <div id="burials" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Agendamento de Sepultamento</h2>
                <form onsubmit="scheduleBurial(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Nome do Falecido *</label>
                            <input type="text" name="nomefalecido" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Data do Sepultamento *</label>
                            <input type="date" name="data" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Horário *</label>
                            <select name="horario" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="">Selecione o horário</option>
                                <option value="08:30">08:30</option>
                                <option value="09:00">09:00</option>
                                <option value="09:30">09:30</option>
                                <option value="10:00">10:00</option>
                                <option value="10:30">10:30</option>
                                <option value="11:00">11:00</option>
                                <option value="11:30">11:30</option>
                                <option value="12:00">12:00</option>
                                <option value="12:30">12:30</option>
                                <option value="13:00">13:00</option>
                                <option value="13:30">13:30</option>
                                <option value="14:00">14:00</option>
                                <option value="14:30">14:30</option>
                                <option value="15:00">15:00</option>
                                <option value="15:30">15:30</option>
                                <option value="custom">Horário personalizado</option>
                            </select>
                        </div>
                        <div id="customTimeField" class="hidden">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Horário Personalizado</label>
                            <input type="time" name="horarioCustom" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Velório</label>
                            <input type="text" name="velorio" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Funerária *</label>
                            <select name="funeraria" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="">Selecione a funerária</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Sepultura *</label>
                            <select name="sepultura" required onchange="toggleManualGrave(this.value)" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="">Selecione uma sepultura aberta</option>
                                <option value="manual">Inserir manualmente</option>
                            </select>
                        </div>
                        <div id="manualGraveFields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Quadra *</label>
                                <input type="text" name="quadraManual" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Lote *</label>
                                <input type="text" name="loteManual" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Agentes Sepultadores</label>
                        <div id="agentSelection" class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-40 overflow-y-auto border border-slate-200 rounded-lg p-3">
                            <p class="text-slate-500 col-span-2">Nenhum agente cadastrado</p>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                        Agendar Sepultamento
                    </button>
                </form>
            </div>

            <!-- Burial Calendar View -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8 border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800">Calendário de Sepultamentos</h3>
                    <div class="flex gap-2">
                        <input type="date" id="burialCalendarDate" onchange="updateBurialCalendarView()" class="px-3 py-2 border border-slate-200 rounded-lg">
                        <button onclick="printBurialsByDate()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            🖨️ Imprimir
                        </button>
                    </div>
                </div>
                <div id="burialCalendarView" class="space-y-3">
                    <p class="text-slate-500 text-center py-8">Selecione uma data para ver os sepultamentos</p>
                </div>
            </div>

            <!-- Burials List -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8 border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800">Todos os Sepultamentos Agendados</h3>
                    <button onclick="toggleBurialsList()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                        <span id="burialsToggleIcon">▼</span>
                        <span id="burialsToggleText">Mostrar</span>
                    </button>
                </div>
                <div id="burialsListContainer" class="hidden">
                    <div class="mb-4">
                        <input type="text" id="searchBurials" placeholder="Pesquisar por nome, funerária, quadra ou lote..." class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" oninput="filterBurials()">
                    </div>
                    <div id="burialsList" class="space-y-3">
                        <p class="text-slate-500 text-center py-8">Nenhum sepultamento agendado</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agents Section -->
        <div id="agents" class="section hidden animate-slide-in">
            <!-- Agent Registration Form -->
            <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden mb-8">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 via-emerald-600 to-emerald-700"></div>
                <div class="mb-8">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-700 dark:from-emerald-400 dark:to-emerald-500 bg-clip-text text-transparent mb-2">
                        Cadastro de Agentes Sepultadores
                    </h2>
                    <p class="text-slate-600 dark:text-slate-400">Registre novos agentes no sistema</p>
                </div>
                <form onsubmit="registerAgent(event)" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-emerald-600 dark:group-focus-within:text-emerald-400 transition-colors">
                                👤 Nome Completo *
                            </label>
                            <input type="text" name="nome" required class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md" placeholder="Nome completo do agente">
                        </div>
                        <div class="group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-emerald-600 dark:group-focus-within:text-emerald-400 transition-colors">
                                📱 Telefone *
                            </label>
                            <input type="tel" name="telefone" required oninput="formatPhone(this)" class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md" placeholder="(11) 99999-9999">
                        </div>
                        <div class="group">
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 group-focus-within:text-emerald-600 dark:group-focus-within:text-emerald-400 transition-colors">
                                🆔 RGF *
                            </label>
                            <input type="text" name="rgf" required class="w-full px-4 py-4 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm hover:shadow-md" placeholder="Número do RGF">
                        </div>
                    </div>
                    <button type="submit" class="btn-modern w-full bg-gradient-to-r from-emerald-600 to-emerald-700 dark:from-emerald-500 dark:to-emerald-600 text-white py-4 rounded-xl font-semibold hover:from-emerald-700 hover:to-emerald-800 dark:hover:from-emerald-600 dark:hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]">
                        <span class="flex items-center justify-center space-x-3">
                            <span>👷</span>
                            <span>Cadastrar Agente</span>
                            <span class="opacity-0 group-hover:opacity-100 transition-opacity">✨</span>
                        </span>
                    </button>
                </form>
            </div>

            <!-- Monthly Ranking Card -->
            <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden mb-8">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 via-amber-600 to-amber-700"></div>
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-amber-600 to-amber-700 dark:from-amber-400 dark:to-amber-500 bg-clip-text text-transparent mb-2">
                            🏆 Ranking Mensal dos Agentes
                        </h3>
                        <p class="text-slate-600 dark:text-slate-400">Desempenho dos agentes por mês</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <select id="monthSelector" onchange="updateMonthlyRanking()" class="px-4 py-2 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-amber-500/20 focus:border-amber-500 dark:focus:border-amber-400 transition-all duration-300 bg-white dark:bg-slate-700 shadow-sm">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <button onclick="printMonthlyRanking()" class="btn-modern bg-gradient-to-r from-indigo-600 to-indigo-700 dark:from-indigo-500 dark:to-indigo-600 text-white px-4 py-2 rounded-xl hover:from-indigo-700 hover:to-indigo-800 dark:hover:from-indigo-600 dark:hover:to-indigo-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                            <span class="flex items-center space-x-2">
                                <span>🖨️</span>
                                <span>Imprimir</span>
                            </span>
                        </button>
                    </div>
                </div>
                <div id="monthlyRanking" class="space-y-4">
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl opacity-50">🏆</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-lg">Selecione um mês para ver o ranking</p>
                        <p class="text-slate-400 dark:text-slate-500 text-sm mt-2">O ranking será baseado no total de trabalhos realizados</p>
                    </div>
                </div>
            </div>

            <!-- Agents List -->
            <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-8 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 via-emerald-600 to-emerald-700"></div>
                <div class="mb-8">
                    <h3 class="text-2xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-700 dark:from-emerald-400 dark:to-emerald-500 bg-clip-text text-transparent mb-2">
                        Agentes Cadastrados
                    </h3>
                    <p class="text-slate-600 dark:text-slate-400">Ranking geral de desempenho</p>
                </div>
                <div id="agentsList" class="space-y-6">
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl opacity-50">👷</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum agente cadastrado</p>
                        <p class="text-slate-400 dark:text-slate-500 text-sm mt-2">Os agentes cadastrados aparecerão aqui com suas estatísticas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Funeral Homes Section -->
        <div id="funeral-homes" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Cadastro de Funerárias</h2>
                <form onsubmit="registerFuneralHome(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Nome da Funerária *</label>
                            <input type="text" name="nome" required class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Telefone *</label>
                            <input type="tel" name="telefone" required oninput="formatPhone(this)" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="(11) 99999-9999">
                        </div>
                    </div>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                        Cadastrar Funerária
                    </button>
                </form>
            </div>

            <!-- Funeral Homes List -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8 border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Funerárias Cadastradas</h3>
                <div id="funeralHomesList" class="space-y-3">
                    <p class="text-slate-500 text-center py-8">Nenhuma funerária cadastrada</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="app.js"></script>
    <script src="views.js"></script>
    <script src="actions.js"></script>
    <script src="reports.js"></script>
    <script>





        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            
            if (sectionId === 'dashboard') {
                updateDashboard();
            } else if (sectionId === 'burials') {
                updateBurialForm();
            } else if (sectionId === 'open-graves') {
                updateOpenGravesManagement();
            } else if (sectionId === 'agents') {
                updateAgentsList();
                populateMonthSelector();
            }
        }

        // Phone formatting
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                if (value.length < 14) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                }
            }
            input.value = value;
        }

        // WhatsApp link generator
        function generateWhatsAppLink(phone) {
            const cleanNumber = phone.replace(/\D/g, '');
            const whatsappNumber = cleanNumber.startsWith('55') ? cleanNumber : '55' + cleanNumber;
            return `https://wa.me/${whatsappNumber}`;
        }

        // Destination fields for exhumations
        function showDestinationFields(destination) {
            const fieldsContainer = document.getElementById('destinationFields');
            fieldsContainer.innerHTML = '';

            switch(destination) {
                case 'nicho':
                    fieldsContainer.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Número do Nicho *</label>
                            <input type="text" name="numeroNicho" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: N-123A">
                        </div>
                    `;
                    break;
                case 'sepulcro':
                    fieldsContainer.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quadra do Sepulcro *</label>
                                <input type="text" name="quadraSepulcro" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Número do Sepulcro *</label>
                                <input type="text" name="numeroSepulcro" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    `;
                    break;
                case 'sepultura':
                    fieldsContainer.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quadra *</label>
                                <input type="text" name="quadraDestino" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: A, B, 1, 2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lote *</label>
                                <input type="text" name="loteDestino" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: 123, 45A">
                            </div>
                        </div>
                    `;
                    break;
                case 'traslado-crematório':
                    fieldsContainer.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Número do Protocolo *</label>
                            <input type="text" name="protocolo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    `;
                    break;
                case 'traslado':
                    fieldsContainer.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Destino *</label>
                                <input type="text" name="destinoTraslado" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Número do Protocolo *</label>
                                <input type="text" name="protocolo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // Custom time field toggle
        document.addEventListener('change', function(e) {
            if (e.target.name === 'horario') {
                const customField = document.getElementById('customTimeField');
                if (e.target.value === 'custom') {
                    customField.classList.remove('hidden');
                    customField.querySelector('input').required = true;
                } else {
                    customField.classList.add('hidden');
                    customField.querySelector('input').required = false;
                }
            }
        });

        // Manual grave toggle
        function toggleManualGrave(value) {
            const manualFields = document.getElementById('manualGraveFields');
            const quadraInput = document.querySelector('input[name="quadraManual"]');
            const loteInput = document.querySelector('input[name="loteManual"]');
            
            if (value === 'manual') {
                manualFields.classList.remove('hidden');
                quadraInput.required = true;
                loteInput.required = true;
            } else {
                manualFields.classList.add('hidden');
                quadraInput.required = false;
                loteInput.required = false;
                quadraInput.value = '';
                loteInput.value = '';
            }
        }

        // Schedule exhumation
        async function scheduleExhumation(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            data.status = 'agendada';
            data.whatsappLink = generateWhatsAppLink(data.telefone);
            data.agenteSepultador = '';
            data.conclusao = '';
            data.createdAt = new Date().toISOString();
            
            const docId = await saveToFirebase('exhumations', data);
            data.id = docId;
            exhumations.push(data);
            
            showSuccess('Exumação agendada com sucesso!');
            event.target.reset();
            document.getElementById('destinationFields').innerHTML = '';
            updateCalendarView();
            updateDashboard();
        }

        // Schedule burial
        async function scheduleBurial(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            data.agentes = Array.from(document.querySelectorAll('#agentSelection input:checked')).map(cb => cb.value);
            data.createdAt = new Date().toISOString();
            
            // Use custom time if selected
            if (data.horario === 'custom') {
                data.horario = data.horarioCustom;
            }
            
            // Handle manual grave entry
            if (data.sepultura === 'manual') {
                data.sepultura = `${data.quadraManual}-${data.loteManual}`;
                data.quadra = data.quadraManual;
                data.lote = data.loteManual;
            } else {
                // Extract quadra and lote from existing grave
                const grave = openGraves.find(g => g.id === data.sepultura);
                if (grave) {
                    data.quadra = grave.quadra;
                    data.lote = grave.lote;
                }
            }
            
            const docId = await saveToFirebase('burials', data);
            data.id = docId;
            burials.push(data);
            
            // Remove grave from open graves only if it was selected from the list
            if (data.sepultura !== `${data.quadraManual}-${data.loteManual}`) {
                const graveToRemove = openGraves.find(g => g.id === data.sepultura);
                if (graveToRemove) {
                    await deleteFromFirebase('openGraves', graveToRemove.id);
                    openGraves = openGraves.filter(g => g.id !== data.sepultura);
                }
            }
            
            showSuccess('Sepultamento agendado com sucesso!');
            event.target.reset();
            document.getElementById('manualGraveFields').classList.add('hidden');
            updateBurialsList();
            updateBurialCalendarView();
            updateBurialForm();
            updateDashboard();
        }

        // Register agent
        async function registerAgent(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            data.whatsappLink = generateWhatsAppLink(data.telefone);
            data.createdAt = new Date().toISOString();
            
            const docId = await saveToFirebase('agents', data);
            data.id = docId;
            agents.push(data);
            
            showSuccess('Agente cadastrado com sucesso!');
            event.target.reset();
            updateAgentsList();
            updateBurialForm();
            updateDashboard();
        }

        // Register open grave
        async function registerOpenGrave(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // Check if grave already exists
            const graveId = `${data.quadra}-${data.lote}`;
            const existingGrave = openGraves.find(g => g.id === graveId);
            
            if (existingGrave) {
                alert('Esta sepultura já está cadastrada como aberta!');
                return;
            }
            
            data.dataAbertura = new Date().toLocaleDateString('pt-BR');
            data.dataCadastro = new Date().toISOString();
            data.graveId = graveId;
            
            const docId = await saveToFirebase('openGraves', data);
            data.id = docId;
            openGraves.push(data);
            
            showSuccess('Sepultura aberta cadastrada com sucesso!');
            event.target.reset();
            updateOpenGravesManagement();
            updateBurialForm();
            updateDashboard();
        }

        // Register funeral home
        async function registerFuneralHome(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            data.whatsappLink = generateWhatsAppLink(data.telefone);
            data.createdAt = new Date().toISOString();
            
            const docId = await saveToFirebase('funeralHomes', data);
            data.id = docId;
            funeralHomes.push(data);
            
            showSuccess('Funerária cadastrada com sucesso!');
            event.target.reset();
            updateFuneralHomesList();
            updateBurialForm();
        }

        // Update functions
        function updateDashboard() {
            document.getElementById('exhumationCount').textContent = exhumations.length;
            document.getElementById('burialCount').textContent = burials.length;
            document.getElementById('openGravesCount').textContent = openGraves.length;
            document.getElementById('agentCount').textContent = agents.length;
            updateOpenGravesList();
        }

        function updateOpenGravesList() {
            const container = document.getElementById('openGravesList');
            if (openGraves.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma sepultura aberta no momento</p>';
                return;
            }
            
            container.innerHTML = openGraves.map(grave => `
                <div class="flex justify-between items-center p-4 border border-gray-200 rounded-lg">
                    <div>
                        <span class="font-semibold">Quadra ${grave.quadra} - Lote ${grave.lote}</span>
                        <span class="text-sm text-gray-600 ml-4">Aberta em: ${grave.dataAbertura}</span>
                        <span class="text-sm text-blue-600 ml-4">Origem: ${grave.origem}</span>
                    </div>
                    <button onclick="extendExhumationDeadline('${grave.id}')" class="bg-amber-500 text-white px-3 py-1 rounded text-sm hover:bg-amber-600 transition-colors">
                        Prorrogar Prazo
                    </button>
                </div>
            `).join('');
        }

        // Burial calendar view functions
        function updateBurialCalendarView() {
            const selectedDate = document.getElementById('burialCalendarDate').value;
            const container = document.getElementById('burialCalendarView');
            
            if (!selectedDate) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Selecione uma data para ver os sepultamentos</p>';
                return;
            }
            
            const dayBurials = burials.filter(burial => burial.data === selectedDate);
            
            if (dayBurials.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum sepultamento agendado para esta data</p>';
                return;
            }
            
            // Sort by time
            dayBurials.sort((a, b) => {
                const timeA = a.horario || '00:00';
                const timeB = b.horario || '00:00';
                return timeA.localeCompare(timeB);
            });
            
            container.innerHTML = dayBurials.map(burial => `
                <div class="p-4 border border-gray-200 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <h4 class="font-semibold text-lg">${burial.nomefalecido}</h4>
                            <p class="text-sm text-gray-600">Horário: ${burial.horario}</p>
                            <p class="text-sm text-gray-600">Quadra ${burial.quadra} - Lote ${burial.lote}</p>
                            <p class="text-sm text-gray-600">Funerária: ${burial.funeraria}</p>
                            ${(() => {
                                const funeralHome = funeralHomes.find(fh => fh.nome === burial.funeraria);
                                if (funeralHome) {
                                    const greeting = new Date().getHours() < 12 ? 'Bom dia' : 'Boa tarde';
                                    const today = new Date().toISOString().split('T')[0];
                                    const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                                    let dateText;
                                    if (burial.data === today) {
                                        dateText = 'hoje';
                                    } else if (burial.data === tomorrow) {
                                        dateText = 'amanhã';
                                    } else {
                                        dateText = new Date(burial.data).toLocaleDateString('pt-BR');
                                    }
                                    const message = `${greeting}, podemos agendar *${burial.nomefalecido}*, para ${dateText}, às ${burial.horario} horas`;
                                    const whatsappLink = `https://wa.me/${funeralHome.telefone.replace(/\D/g, '').startsWith('55') ? funeralHome.telefone.replace(/\D/g, '') : '55' + funeralHome.telefone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                                    return `<p class="text-sm text-gray-600">Tel: <a href="${whatsappLink}" target="_blank" class="text-green-600 hover:text-green-700 underline">${funeralHome.telefone}</a></p>`;
                                }
                                return '';
                            })()}
                            ${burial.velorio ? `<p class="text-sm text-gray-600">Velório: ${burial.velorio}</p>` : ''}
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-2">
                                <strong>Agentes:</strong> 
                                ${burial.agentes && burial.agentes.length > 0 ? burial.agentes.join(', ') : 'Não definido'}
                            </p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="editBurialAgents('${burial.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 transition-colors">
                                Editar Agentes
                            </button>
                            <button onclick="editBurial('${burial.id}')" class="bg-amber-500 text-white px-3 py-1 rounded text-sm hover:bg-amber-600 transition-colors">
                                Editar
                            </button>
                            <button onclick="deleteBurial('${burial.id}')" class="bg-rose-600 text-white px-3 py-1 rounded text-sm hover:bg-rose-700 transition-colors">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Calendar view functions
        function updateCalendarView() {
            const selectedDate = document.getElementById('calendarDate').value;
            const container = document.getElementById('calendarView');
            
            if (!selectedDate) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Selecione uma data para ver as exumações</p>';
                return;
            }
            
            const dayExhumations = exhumations.filter(ex => ex.dataExumacao === selectedDate);
            
            if (dayExhumations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma exumação agendada para esta data</p>';
                return;
            }
            
            container.innerHTML = dayExhumations.map(ex => {
                // Build destination info with additional details
                let destinoInfo = ex.destino;
                if (ex.destino === 'sepultura' && ex.quadraDestino && ex.loteDestino) {
                    destinoInfo += ` (Quadra ${ex.quadraDestino} - Lote ${ex.loteDestino})`;
                } else if (ex.destino === 'nicho' && ex.numeroNicho) {
                    destinoInfo += ` (${ex.numeroNicho})`;
                } else if (ex.destino === 'sepulcro' && ex.quadraSepulcro && ex.numeroSepulcro) {
                    destinoInfo += ` (Quadra ${ex.quadraSepulcro} - Nº ${ex.numeroSepulcro})`;
                } else if (ex.destino === 'traslado' && ex.destinoTraslado) {
                    destinoInfo += ` (${ex.destinoTraslado})`;
                } else if ((ex.destino === 'traslado-crematório' || ex.destino === 'traslado') && ex.protocolo) {
                    destinoInfo += ` (Protocolo: ${ex.protocolo})`;
                }
                
                return `
                <div class="p-4 border border-gray-200 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <h4 class="font-semibold text-lg">${ex.nomefalecido}</h4>
                            <p class="text-sm text-gray-600">Quadra ${ex.quadra} - Lote ${ex.lote}</p>
                            <p class="text-sm text-gray-600">Destino: ${destinoInfo}</p>
                            <p class="text-sm text-gray-600">Solicitante: ${ex.solicitante}</p>
                            ${ex.conclusao ? `<p class="text-sm font-medium text-green-600">Conclusão: ${ex.conclusao}</p>` : ''}
                        </div>
                        <div>
                            <div class="mb-2">
                                <label class="block text-xs text-gray-500 mb-1">Agente Sepultador:</label>
                                <select onchange="updateExhumationAgent('${ex.id}', this.value)" class="w-full text-sm px-2 py-1 border border-gray-300 rounded">
                                    <option value="">Selecionar agente</option>
                                    ${agents.map(agent => `
                                        <option value="${agent.nome}" ${ex.agenteSepultador === agent.nome ? 'selected' : ''}>${agent.nome}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <a href="${(() => {
                                const greeting = new Date().getHours() < 12 ? 'Bom dia' : 'Boa tarde';
                                const dataFormatted = new Date(ex.dataExumacao + 'T00:00:00').toLocaleDateString('pt-BR');
                                let destinoInfo = ex.destino;
                                if (ex.destino === 'sepultura' && ex.quadraDestino && ex.loteDestino) {
                                    destinoInfo += ` (Quadra ${ex.quadraDestino} - Lote ${ex.loteDestino})`;
                                } else if (ex.destino === 'nicho' && ex.numeroNicho) {
                                    destinoInfo += ` (${ex.numeroNicho})`;
                                } else if (ex.destino === 'sepulcro' && ex.quadraSepulcro && ex.numeroSepulcro) {
                                    destinoInfo += ` (Quadra ${ex.quadraSepulcro} - Nº ${ex.numeroSepulcro})`;
                                } else if (ex.destino === 'traslado' && ex.destinoTraslado) {
                                    destinoInfo += ` (${ex.destinoTraslado})`;
                                } else if ((ex.destino === 'traslado-crematório' || ex.destino === 'traslado') && ex.protocolo) {
                                    destinoInfo += ` (Protocolo: ${ex.protocolo})`;
                                }
                                const message = `${greeting}! Confirmação do agendamento de exumação:\n\n*Nome do Falecido:* ${ex.nomefalecido}\n*Data da Exumação:* ${dataFormatted}\n*Localização:* Quadra ${ex.quadra} - Lote ${ex.lote}\n*Destino:* ${destinoInfo}\n*Livro:* ${ex.livro}\n*Página:* ${ex.pagina}\n*Solicitante:* ${ex.solicitante}\n\nAgendamento confirmado!`;
                                const cleanNumber = ex.telefone.replace(/\D/g, '');
                                const whatsappNumber = cleanNumber.startsWith('55') ? cleanNumber : '55' + cleanNumber;
                                return `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
                            })()}" class="inline-block bg-teal-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700 transition-colors">
                                WhatsApp
                            </a>
                        </div>
                        <div class="flex flex-col gap-2">
                            ${ex.status === 'agendada' ? `
                                <button onclick="editExhumation('${ex.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 transition-colors">
                                    Editar
                                </button>
                                <button onclick="deleteExhumation('${ex.id}')" class="bg-rose-600 text-white px-3 py-1 rounded text-sm hover:bg-rose-700 transition-colors">
                                    Excluir
                                </button>
                                <button onclick="completeExhumation('${ex.id}')" class="bg-teal-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700 transition-colors">
                                    Concluir
                                </button>
                            ` : `
                                <span class="text-sm font-medium text-slate-600">Status: ${ex.status}</span>
                                ${ex.status === 'concluída' ? `
                                    <button onclick="editExhumationConclusion('${ex.id}')" class="bg-amber-500 text-white px-3 py-1 rounded text-sm hover:bg-amber-600 transition-colors">
                                        Editar Conclusão
                                    </button>
                                ` : ''}
                                <button onclick="deleteExhumation('${ex.id}')" class="bg-slate-800 text-white px-3 py-1 rounded text-sm hover:bg-slate-900 transition-colors">
                                    Excluir
                                </button>
                            `}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Exhumation management functions
        async function updateExhumationAgent(exhumationId, agentName) {
            const exhumation = exhumations.find(ex => ex.id === exhumationId);
            if (exhumation) {
                exhumation.agenteSepultador = agentName;
                await updateFirebase('exhumations', exhumationId, { agenteSepultador: agentName });
                showSuccess('Agente atualizado com sucesso!');
            }
        }

        function editExhumation(exhumationId) {
            const exhumation = exhumations.find(ex => ex.id === exhumationId);
            if (!exhumation) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">Editar Exumação</h3>
                    <form onsubmit="saveExhumationEdit(event, '${exhumationId}')">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Data da Exumação</label>
                                <input type="date" name="dataExumacao" value="${exhumation.dataExumacao}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Nome do Falecido</label>
                                <input type="text" name="nomefalecido" value="${exhumation.nomefalecido}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Quadra</label>
                                <input type="text" name="quadra" value="${exhumation.quadra}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Lote</label>
                                <input type="text" name="lote" value="${exhumation.lote}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Solicitante</label>
                                <input type="text" name="solicitante" value="${exhumation.solicitante}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Telefone</label>
                                <input type="tel" name="telefone" value="${exhumation.telefone}" required class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Salvar</button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveExhumationEdit(event, exhumationId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            const exhumation = exhumations.find(ex => ex.id === exhumationId);
            if (exhumation) {
                Object.assign(exhumation, data);
                exhumation.whatsappLink = generateWhatsAppLink(data.telefone);
                await updateFirebase('exhumations', exhumationId, { ...data, whatsappLink: exhumation.whatsappLink });
                showSuccess('Exumação atualizada com sucesso!');
                updateCalendarView();
                event.target.closest('.fixed').remove();
            }
        }



        function completeExhumation(exhumationId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">Concluir Exumação</h3>
                    <div class="space-y-3">
                        <button onclick="finishExhumation('${exhumationId}', 'exumado')" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                            Exumado
                        </button>
                        <button onclick="showExtensionOptions('${exhumationId}')" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700">
                            Não saiu + prazo
                        </button>
                        <button onclick="finishExhumation('${exhumationId}', 'gaveta-espera')" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                            Gaveta de Espera
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 text-white py-2 rounded hover:bg-gray-700">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showExtensionOptions(exhumationId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">Prorrogar Prazo</h3>
                    <div class="space-y-3">
                        <button onclick="finishExhumation('${exhumationId}', 'prorrogado-1-ano')" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700">
                            + 1 ano
                        </button>
                        <button onclick="finishExhumation('${exhumationId}', 'prorrogado-2-anos')" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700">
                            + 2 anos
                        </button>
                        <button onclick="finishExhumation('${exhumationId}', 'prorrogado-3-anos')" class="w-full bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700">
                            + 3 anos
                        </button>
                        <div class="flex gap-2">
                            <input type="number" id="customYears" placeholder="Anos" class="flex-1 px-3 py-2 border rounded">
                            <button onclick="finishExhumation('${exhumationId}', 'prorrogado-' + document.getElementById('customYears').value + '-anos')" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                                Confirmar
                            </button>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 text-white py-2 rounded hover:bg-gray-700">
                            Voltar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function finishExhumation(exhumationId, conclusion) {
            const exhumation = exhumations.find(ex => ex.id === exhumationId);
            if (!exhumation) return;
            
            exhumation.status = 'concluída';
            exhumation.conclusao = conclusion;
            
            const graveId = `${exhumation.quadra}-${exhumation.lote}`;
            
            if (conclusion === 'exumado' || conclusion === 'gaveta-espera') {
                // Add to open graves
                if (!openGraves.find(g => g.graveId === graveId)) {
                    const graveData = {
                        graveId: graveId,
                        quadra: exhumation.quadra,
                        lote: exhumation.lote,
                        dataAbertura: new Date().toLocaleDateString('pt-BR'),
                        origem: 'exumação',
                        dataCadastro: new Date().toISOString()
                    };
                    const docId = await saveToFirebase('openGraves', graveData);
                    graveData.id = docId;
                    openGraves.push(graveData);
                }
                
                // If gaveta de espera, add to waiting drawer
                if (conclusion === 'gaveta-espera') {
                    const drawerData = {
                        nomefalecido: exhumation.nomefalecido,
                        quadraOriginal: exhumation.quadra,
                        loteOriginal: exhumation.lote,
                        dataEntrada: new Date().toLocaleDateString('pt-BR'),
                        createdAt: new Date().toISOString()
                    };
                    const docId = await saveToFirebase('waitingDrawer', drawerData);
                    drawerData.id = docId;
                    waitingDrawer.push(drawerData);
                    updateWaitingDrawerList();
                }
            }
            
            await updateFirebase('exhumations', exhumationId, { status: 'concluída', conclusao: conclusion });
            showSuccess('Exumação concluída!');
            updateCalendarView();
            updateDashboard();
            
            // Close all modals
            document.querySelectorAll('.fixed').forEach(modal => modal.remove());
        }

        function editExhumationConclusion(exhumationId) {
            completeExhumation(exhumationId);
        }

        async function deleteExhumation(exhumationId) {
            if (confirm('Tem certeza que deseja EXCLUIR permanentemente esta exumação? Esta ação não pode ser desfeita.')) {
                await deleteFromFirebase('exhumations', exhumationId);
                exhumations = exhumations.filter(ex => ex.id !== exhumationId);
                showSuccess('Exumação excluída permanentemente!');
                updateCalendarView();
                updateDashboard();
            }
        }

        function updateBurialsList() {
            const container = document.getElementById('burialsList');
            if (burials.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum sepultamento agendado</p>';
                return;
            }
            
            renderBurialsList(burials);
        }
        
        function renderBurialsList(burialsToShow) {
            const container = document.getElementById('burialsList');
            
            if (burialsToShow.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum sepultamento encontrado</p>';
                return;
            }
            
            container.innerHTML = burialsToShow.map(burial => `
                <div class="p-4 border border-gray-200 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold">${burial.nomefalecido}</h4>
                            <p class="text-sm text-gray-600">Data: ${new Date(burial.data).toLocaleDateString('pt-BR')} às ${burial.horario}</p>
                            <p class="text-sm text-gray-600">Sepultura: Quadra ${burial.quadra || 'N/A'} - Lote ${burial.lote || 'N/A'}</p>
                            <p class="text-sm text-gray-600">Funerária: ${burial.funeraria}</p>
                            ${(() => {
                                const funeralHome = funeralHomes.find(fh => fh.nome === burial.funeraria);
                                if (funeralHome) {
                                    const greeting = new Date().getHours() < 12 ? 'Bom dia' : 'Boa tarde';
                                    const today = new Date().toISOString().split('T')[0];
                                    const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                                    let dateText;
                                    if (burial.data === today) {
                                        dateText = 'hoje';
                                    } else if (burial.data === tomorrow) {
                                        dateText = 'amanhã';
                                    } else {
                                        dateText = new Date(burial.data).toLocaleDateString('pt-BR');
                                    }
                                    const message = `${greeting}, podemos agendar *${burial.nomefalecido}*, para ${dateText}, às ${burial.horario} horas`;
                                    const whatsappLink = `https://wa.me/${funeralHome.telefone.replace(/\D/g, '').startsWith('55') ? funeralHome.telefone.replace(/\D/g, '') : '55' + funeralHome.telefone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                                    return `<p class="text-sm text-gray-600">Tel: <a href="${whatsappLink}" target="_blank" class="text-green-600 hover:text-green-700 underline">${funeralHome.telefone}</a></p>`;
                                }
                                return '';
                            })()}
                            ${burial.velorio ? `<p class="text-sm text-gray-600">Velório: ${burial.velorio}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <button onclick="editBurialAgents('${burial.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                                Editar Agentes
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleBurialsList() {
            const container = document.getElementById('burialsListContainer');
            const icon = document.getElementById('burialsToggleIcon');
            const text = document.getElementById('burialsToggleText');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                icon.textContent = '▲';
                text.textContent = 'Ocultar';
            } else {
                container.classList.add('hidden');
                icon.textContent = '▼';
                text.textContent = 'Mostrar';
            }
        }
        
        function filterBurials() {
            const searchTerm = document.getElementById('searchBurials').value.toLowerCase();
            
            if (!searchTerm) {
                renderBurialsList(burials);
                return;
            }
            
            const filteredBurials = burials.filter(burial => 
                burial.nomefalecido.toLowerCase().includes(searchTerm) ||
                burial.funeraria.toLowerCase().includes(searchTerm) ||
                (burial.quadra && burial.quadra.toLowerCase().includes(searchTerm)) ||
                (burial.lote && burial.lote.toLowerCase().includes(searchTerm)) ||
                (burial.velorio && burial.velorio.toLowerCase().includes(searchTerm))
            );
            
            renderBurialsList(filteredBurials);
        }

        function updateAgentsList() {
            const container = document.getElementById('agentsList');
            if (agents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum agente cadastrado</p>';
                return;
            }
            
            // Calculate statistics for each agent
            const agentsWithStats = agents.map(agent => {
                const exhumationCount = exhumations.filter(ex => ex.agenteSepultador === agent.nome).length;
                const burialCount = burials.filter(burial => burial.agentes && burial.agentes.includes(agent.nome)).length;
                const totalJobs = exhumationCount + burialCount;
                
                return {
                    ...agent,
                    exhumationCount,
                    burialCount,
                    totalJobs
                };
            });
            
            // Sort by total jobs (descending)
            agentsWithStats.sort((a, b) => b.totalJobs - a.totalJobs);
            
            container.innerHTML = agentsWithStats.map((agent, index) => `
                <div class="card-hover bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-xl p-6 border border-slate-200/50 dark:border-slate-700/50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-emerald-500/10 to-emerald-600/10 rounded-full -mr-12 -mt-12"></div>
                    <div class="relative">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                                        #${index + 1}
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-slate-800 dark:text-slate-200">${agent.nome}</h4>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">RGF: ${agent.rgf}</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-teal-600 dark:text-teal-400">${agent.exhumationCount}</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide">Exumações</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${agent.burialCount}</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide">Sepultamentos</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${agent.totalJobs}</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide">Total</div>
                                    </div>
                                </div>
                                
                                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 mb-3">
                                    <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 h-2 rounded-full transition-all duration-500" style="width: ${agent.totalJobs > 0 ? Math.min((agent.totalJobs / Math.max(...agentsWithStats.map(a => a.totalJobs))) * 100, 100) : 0}%"></div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2 ml-4">
                                <a href="${agent.whatsappLink}" target="_blank" class="btn-modern bg-gradient-to-r from-green-600 to-green-700 dark:from-green-500 dark:to-green-600 text-white px-4 py-2 rounded-xl hover:from-green-700 hover:to-green-800 dark:hover:from-green-600 dark:hover:to-green-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl text-center">
                                    <span class="flex items-center space-x-2">
                                        <span>💬</span>
                                        <span>WhatsApp</span>
                                    </span>
                                </a>
                                <button onclick="viewAgentDetails('${agent.nome}')" class="btn-modern bg-gradient-to-r from-indigo-600 to-indigo-700 dark:from-indigo-500 dark:to-indigo-600 text-white px-4 py-2 rounded-xl hover:from-indigo-700 hover:to-indigo-800 dark:hover:from-indigo-600 dark:hover:to-indigo-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                                    <span class="flex items-center space-x-2">
                                        <span>📊</span>
                                        <span>Detalhes</span>
                                    </span>
                                </button>
                                <button onclick="editAgent('${agent.id}')" class="btn-modern bg-gradient-to-r from-amber-600 to-amber-700 dark:from-amber-500 dark:to-amber-600 text-white px-4 py-2 rounded-xl hover:from-amber-700 hover:to-amber-800 dark:hover:from-amber-600 dark:hover:to-amber-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                                    <span class="flex items-center space-x-2">
                                        <span>✏️</span>
                                        <span>Editar</span>
                                    </span>
                                </button>
                                <button onclick="deleteAgent('${agent.id}')" class="btn-modern bg-gradient-to-r from-rose-600 to-rose-700 dark:from-rose-500 dark:to-rose-600 text-white px-4 py-2 rounded-xl hover:from-rose-700 hover:to-rose-800 dark:hover:from-rose-600 dark:hover:to-rose-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl">
                                    <span class="flex items-center space-x-2">
                                        <span>🗑️</span>
                                        <span>Excluir</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateFuneralHomesList() {
            const container = document.getElementById('funeralHomesList');
            if (funeralHomes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Nenhuma funerária cadastrada</p>';
                return;
            }
            
            // Calculate dynamic participation count
            const funeralHomesWithStats = funeralHomes.map(fh => {
                const participationCount = burials.filter(burial => burial.funeraria === fh.nome).length;
                return { ...fh, participacoes: participationCount };
            });
            
            container.innerHTML = funeralHomesWithStats.map(fh => `
                <div class="flex justify-between items-center p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800">
                    <div>
                        <span class="font-semibold text-slate-800 dark:text-slate-200">${fh.nome}</span>
                        <span class="text-sm text-gray-600 dark:text-gray-400 ml-4">Participações: ${fh.participacoes}</span>
                    </div>
                    <div class="flex gap-2">
                        <a href="${fh.whatsappLink}" target="_blank" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors">
                            WhatsApp
                        </a>
                        <button onclick="editFuneralHome('${fh.id}')" class="bg-amber-600 text-white px-3 py-1 rounded text-sm hover:bg-amber-700 transition-colors">
                            Editar
                        </button>
                        <button onclick="deleteFuneralHome('${fh.id}')" class="bg-rose-600 text-white px-3 py-1 rounded text-sm hover:bg-rose-700 transition-colors">
                            Excluir
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateBurialForm() {
            // Update funeral homes dropdown
            const funerariaSelect = document.querySelector('select[name="funeraria"]');
            funerariaSelect.innerHTML = '<option value="">Selecione a funerária</option>' +
                funeralHomes.map(fh => `<option value="${fh.nome}">${fh.nome}</option>`).join('');
            
            // Update open graves dropdown
            const sepulturaSelect = document.querySelector('select[name="sepultura"]');
            sepulturaSelect.innerHTML = '<option value="">Selecione uma sepultura aberta</option>' +
                openGraves.map(grave => `<option value="${grave.id}">Quadra ${grave.quadra} - Lote ${grave.lote}</option>`).join('') +
                '<option value="manual">Inserir manualmente</option>';
            
            // Update agents checkboxes
            const agentContainer = document.getElementById('agentSelection');
            if (agents.length === 0) {
                agentContainer.innerHTML = '<p class="text-gray-500 col-span-2">Nenhum agente cadastrado</p>';
            } else {
                agentContainer.innerHTML = agents.map(agent => `
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="${agent.nome}" class="rounded">
                        <span class="text-sm">${agent.nome}</span>
                    </label>
                `).join('');
            }
        }

        // Extend exhumation deadline
        function extendExhumationDeadline(graveId) {
            const years = prompt('Quantos anos a mais? (1, 2, 3 ou mais)', '1');
            if (years && !isNaN(years)) {
                showSuccess(`Prazo prorrogado por ${years} ano(s) para a sepultura ${graveId}`);
            }
        }

        // Edit burial agents
        function editBurialAgents(burialId) {
            const burial = burials.find(b => b.id === burialId);
            if (!burial) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">Editar Agentes - ${burial.nomefalecido}</h3>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        ${agents.map(agent => `
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="${agent.nome}" ${burial.agentes?.includes(agent.nome) ? 'checked' : ''}>
                                <span>${agent.nome}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveAgentChanges('${burialId}', this.parentElement.parentElement)" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Salvar
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveAgentChanges(burialId, modal) {
            const burial = burials.find(b => b.id === burialId);
            const selectedAgents = Array.from(modal.querySelectorAll('input:checked')).map(cb => cb.value);
            burial.agentes = selectedAgents;
            await updateFirebase('burials', burialId, { agentes: selectedAgents });
            modal.parentElement.remove();
            updateBurialsList();
            updateBurialCalendarView();
            showSuccess('Agentes atualizados com sucesso!');
        }

        function editBurial(burialId) {
            const burial = burials.find(b => b.id === burialId);
            if (!burial) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">Editar Sepultamento</h3>
                    <form onsubmit="saveBurialEdit(event, '${burialId}')">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Nome do Falecido</label>
                                <input type="text" name="nomefalecido" value="${burial.nomefalecido}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Data</label>
                                <input type="date" name="data" value="${burial.data}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Horário</label>
                                <input type="time" name="horario" value="${burial.horario}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Funerária</label>
                                <select name="funeraria" required class="w-full px-3 py-2 border rounded">
                                    ${funeralHomes.map(fh => `<option value="${fh.nome}" ${burial.funeraria === fh.nome ? 'selected' : ''}>${fh.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Quadra</label>
                                <input type="text" name="quadra" value="${burial.quadra}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Lote</label>
                                <input type="text" name="lote" value="${burial.lote}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-medium mb-1">Velório</label>
                                <input type="text" name="velorio" value="${burial.velorio || ''}" class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Salvar</button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveBurialEdit(event, burialId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            const burial = burials.find(b => b.id === burialId);
            if (burial) {
                Object.assign(burial, data);
                await updateFirebase('burials', burialId, data);
                showSuccess('Sepultamento atualizado com sucesso!');
                updateBurialsList();
                updateBurialCalendarView();
                event.target.closest('.fixed').remove();
            }
        }

        async function deleteBurial(burialId) {
            if (confirm('Tem certeza que deseja EXCLUIR permanentemente este sepultamento? Esta ação não pode ser desfeita.')) {
                await deleteFromFirebase('burials', burialId);
                burials = burials.filter(b => b.id !== burialId);
                showSuccess('Sepultamento excluído permanentemente!');
                updateBurialsList();
                updateBurialCalendarView();
                updateDashboard();
                updateFuneralHomesList(); // Update funeral home participation counts
            }
        }

        // Agent management functions
        function editAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-6">Editar Agente</h3>
                    <form onsubmit="saveAgentEdit(event, '${agentId}')">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Nome Completo *</label>
                                <input type="text" name="nome" value="${agent.nome}" required class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400 transition-all duration-300">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Telefone *</label>
                                <input type="tel" name="telefone" value="${agent.telefone}" required oninput="formatPhone(this)" class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400 transition-all duration-300">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">RGF *</label>
                                <input type="text" name="rgf" value="${agent.rgf}" required class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400 transition-all duration-300">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-8">
                            <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-3 rounded-xl font-semibold hover:from-emerald-700 hover:to-emerald-800 transition-all duration-300">
                                Salvar Alterações
                            </button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 text-white py-3 rounded-xl font-semibold hover:from-slate-700 hover:to-slate-800 transition-all duration-300">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveAgentEdit(event, agentId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            const agent = agents.find(a => a.id === agentId);
            if (agent) {
                const oldName = agent.nome;
                Object.assign(agent, data);
                agent.whatsappLink = generateWhatsAppLink(data.telefone);
                
                // Update agent name in exhumations and burials if name changed
                if (oldName !== data.nome) {
                    exhumations.forEach(ex => {
                        if (ex.agenteSepultador === oldName) {
                            ex.agenteSepultador = data.nome;
                        }
                    });
                    
                    burials.forEach(burial => {
                        if (burial.agentes && burial.agentes.includes(oldName)) {
                            const index = burial.agentes.indexOf(oldName);
                            burial.agentes[index] = data.nome;
                        }
                    });
                }
                
                await updateFirebase('agents', agentId, { ...data, whatsappLink: agent.whatsappLink });
                showSuccess('Agente atualizado com sucesso!');
                updateAgentsList();
                updateBurialForm();
                event.target.closest('.fixed').remove();
            }
        }

        async function deleteAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;
            
            // Check if agent has any work assigned
            const hasExhumations = exhumations.some(ex => ex.agenteSepultador === agent.nome);
            const hasBurials = burials.some(burial => burial.agentes && burial.agentes.includes(agent.nome));
            
            let confirmMessage = `Tem certeza que deseja EXCLUIR permanentemente o agente "${agent.nome}"?`;
            
            if (hasExhumations || hasBurials) {
                confirmMessage += `\n\nATENÇÃO: Este agente possui trabalhos registrados no sistema. Ao excluí-lo, os trabalhos permanecerão mas sem agente associado.`;
            }
            
            if (confirm(confirmMessage)) {
                // Remove agent from exhumations
                exhumations.forEach(ex => {
                    if (ex.agenteSepultador === agent.nome) {
                        ex.agenteSepultador = '';
                    }
                });
                
                // Remove agent from burials
                burials.forEach(burial => {
                    if (burial.agentes && burial.agentes.includes(agent.nome)) {
                        burial.agentes = burial.agentes.filter(name => name !== agent.nome);
                    }
                });
                
                // Remove agent from agents list
                agents = agents.filter(a => a.id !== agentId);
                
                await deleteFromFirebase('agents', agentId);
                showSuccess('Agente excluído permanentemente!');
                updateAgentsList();
                updateBurialForm();
                updateDashboard();
            }
        }

        // Funeral home management functions
        function editFuneralHome(funeralHomeId) {
            const funeralHome = funeralHomes.find(fh => fh.id === funeralHomeId);
            if (!funeralHome) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-6">Editar Funerária</h3>
                    <form onsubmit="saveFuneralHomeEdit(event, '${funeralHomeId}')">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Nome da Funerária *</label>
                                <input type="text" name="nome" value="${funeralHome.nome}" required class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-rose-500/20 focus:border-rose-500 dark:focus:border-rose-400 transition-all duration-300">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Telefone *</label>
                                <input type="tel" name="telefone" value="${funeralHome.telefone}" required oninput="formatPhone(this)" class="w-full px-4 py-3 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 rounded-xl focus:ring-4 focus:ring-rose-500/20 focus:border-rose-500 dark:focus:border-rose-400 transition-all duration-300">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-8">
                            <button type="submit" class="flex-1 bg-gradient-to-r from-rose-600 to-rose-700 text-white py-3 rounded-xl font-semibold hover:from-rose-700 hover:to-rose-800 transition-all duration-300">
                                Salvar Alterações
                            </button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 text-white py-3 rounded-xl font-semibold hover:from-slate-700 hover:to-slate-800 transition-all duration-300">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveFuneralHomeEdit(event, funeralHomeId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            const funeralHome = funeralHomes.find(fh => fh.id === funeralHomeId);
            if (funeralHome) {
                const oldName = funeralHome.nome;
                Object.assign(funeralHome, data);
                funeralHome.whatsappLink = generateWhatsAppLink(data.telefone);
                
                // Update funeral home name in burials if name changed
                if (oldName !== data.nome) {
                    burials.forEach(burial => {
                        if (burial.funeraria === oldName) {
                            burial.funeraria = data.nome;
                        }
                    });
                }
                
                await updateFirebase('funeralHomes', funeralHomeId, { ...data, whatsappLink: funeralHome.whatsappLink });
                showSuccess('Funerária atualizada com sucesso!');
                updateFuneralHomesList();
                updateBurialForm();
                event.target.closest('.fixed').remove();
            }
        }

        async function deleteFuneralHome(funeralHomeId) {
            const funeralHome = funeralHomes.find(fh => fh.id === funeralHomeId);
            if (!funeralHome) return;
            
            // Check if funeral home has any burials
            const hasBurials = burials.some(burial => burial.funeraria === funeralHome.nome);
            
            let confirmMessage = `Tem certeza que deseja EXCLUIR permanentemente a funerária "${funeralHome.nome}"?`;
            
            if (hasBurials) {
                confirmMessage += `\n\nATENÇÃO: Esta funerária possui sepultamentos registrados no sistema. Ao excluí-la, os sepultamentos permanecerão mas sem funerária associada.`;
            }
            
            if (confirm(confirmMessage)) {
                // Remove funeral home from burials
                burials.forEach(burial => {
                    if (burial.funeraria === funeralHome.nome) {
                        burial.funeraria = '';
                    }
                });
                
                // Remove funeral home from list
                funeralHomes = funeralHomes.filter(fh => fh.id !== funeralHomeId);
                
                await deleteFromFirebase('funeralHomes', funeralHomeId);
                showSuccess('Funerária excluída permanentemente!');
                updateFuneralHomesList();
                updateBurialForm();
            }
        }

        // Waiting drawer functions
        function updateWaitingDrawerList() {
            const container = document.getElementById('waitingDrawerList');
            if (waitingDrawer.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum resto mortal na gaveta de espera</p>';
                return;
            }
            
            container.innerHTML = waitingDrawer.map(item => `
                <div class="p-4 border border-gray-200 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">${item.nomefalecido}</h4>
                            <p class="text-sm text-gray-600">Origem: Quadra ${item.quadraOriginal} - Lote ${item.loteOriginal}</p>
                            <p class="text-sm text-gray-600">Data de entrada: ${item.dataEntrada}</p>
                        </div>
                        <button onclick="removeFromWaitingDrawer('${item.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                            Remover
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function removeFromWaitingDrawer(itemId) {
            if (confirm('Tem certeza que deseja remover este item da gaveta de espera?')) {
                await deleteFromFirebase('waitingDrawer', itemId);
                waitingDrawer = waitingDrawer.filter(item => item.id !== itemId);
                updateWaitingDrawerList();
                showSuccess('Item removido da gaveta de espera!');
            }
        }

        // Open graves management functions
        function updateOpenGravesManagement() {
            updateOpenGravesStatistics();
            updateOpenGravesManagementList();
        }

        function updateOpenGravesStatistics() {
            const total = openGraves.length;
            const exhumationCount = openGraves.filter(g => g.origem === 'exumação').length;
            const manualCount = openGraves.filter(g => g.origem === 'abertura-manual').length;
            const otherCount = total - exhumationCount - manualCount;

            document.getElementById('totalOpenGraves').textContent = total;
            document.getElementById('exhumationOrigin').textContent = exhumationCount;
            document.getElementById('manualOrigin').textContent = manualCount;
            document.getElementById('otherOrigin').textContent = otherCount;
        }

        function updateOpenGravesManagementList() {
            const container = document.getElementById('openGravesManagementList');
            const searchTerm = document.getElementById('searchGraves')?.value.toLowerCase() || '';
            
            let filteredGraves = openGraves;
            if (searchTerm) {
                filteredGraves = openGraves.filter(grave => 
                    grave.quadra.toLowerCase().includes(searchTerm) || 
                    grave.lote.toLowerCase().includes(searchTerm) ||
                    grave.origem.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredGraves.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma sepultura encontrada</p>';
                return;
            }
            
            // Sort by quadra and lote
            filteredGraves.sort((a, b) => {
                if (a.quadra !== b.quadra) {
                    return a.quadra.localeCompare(b.quadra);
                }
                return a.lote.localeCompare(b.lote);
            });
            
            container.innerHTML = filteredGraves.map(grave => `
                <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-2">
                                <h4 class="text-lg font-semibold text-gray-800">Quadra ${grave.quadra} - Lote ${grave.lote}</h4>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${getOriginBadgeClass(grave.origem)}">
                                    ${grave.origem}
                                </span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                                <p><strong>Data de Abertura:</strong> ${grave.dataAbertura}</p>
                                <p><strong>Origem:</strong> ${grave.origem}</p>
                                ${grave.observacoes ? `<p class="md:col-span-2"><strong>Observações:</strong> ${grave.observacoes}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                            <button onclick="editOpenGrave('${grave.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 transition-colors">
                                Editar
                            </button>
                            <button onclick="removeOpenGrave('${grave.id}')" class="bg-rose-600 text-white px-3 py-1 rounded text-sm hover:bg-rose-700 transition-colors">
                                Remover
                            </button>
                            <button onclick="extendGraveDeadline('${grave.id}')" class="bg-amber-500 text-white px-3 py-1 rounded text-sm hover:bg-amber-600 transition-colors">
                                Prorrogar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getOriginBadgeClass(origem) {
            switch(origem) {
                case 'exumação': return 'bg-green-100 text-green-800';
                case 'abertura-manual': return 'bg-purple-100 text-purple-800';
                case 'transferência': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function filterOpenGraves() {
            updateOpenGravesManagementList();
        }

        function editOpenGrave(graveId) {
            const grave = openGraves.find(g => g.id === graveId);
            if (!grave) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">Editar Sepultura Aberta</h3>
                    <form onsubmit="saveOpenGraveEdit(event, '${graveId}')">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Quadra</label>
                                <input type="text" name="quadra" value="${grave.quadra}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Lote</label>
                                <input type="text" name="lote" value="${grave.lote}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Origem</label>
                                <select name="origem" required class="w-full px-3 py-2 border rounded">
                                    <option value="exumação" ${grave.origem === 'exumação' ? 'selected' : ''}>Exumação</option>
                                    <option value="abertura-manual" ${grave.origem === 'abertura-manual' ? 'selected' : ''}>Abertura Manual</option>
                                    <option value="transferência" ${grave.origem === 'transferência' ? 'selected' : ''}>Transferência</option>
                                    <option value="outros" ${grave.origem === 'outros' ? 'selected' : ''}>Outros</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Observações</label>
                                <textarea name="observacoes" rows="3" class="w-full px-3 py-2 border rounded">${grave.observacoes || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Salvar</button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveOpenGraveEdit(event, oldGraveId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            const newGraveId = `${data.quadra}-${data.lote}`;
            
            // Check if new ID conflicts with existing grave (except current one)
            if (newGraveId !== oldGraveId && openGraves.find(g => g.graveId === newGraveId)) {
                alert('Já existe uma sepultura aberta com esta quadra e lote!');
                return;
            }
            
            const graveIndex = openGraves.findIndex(g => g.id === oldGraveId);
            if (graveIndex !== -1) {
                const existingGrave = openGraves[graveIndex];
                const updatedData = {
                    ...data,
                    graveId: newGraveId
                };
                
                openGraves[graveIndex] = {
                    ...existingGrave,
                    ...updatedData
                };
                
                await updateFirebase('openGraves', oldGraveId, updatedData);
                showSuccess('Sepultura atualizada com sucesso!');
                updateOpenGravesManagement();
                updateBurialForm();
                event.target.closest('.fixed').remove();
            }
        }

        async function removeOpenGrave(graveId) {
            if (confirm('Tem certeza que deseja remover esta sepultura da lista de abertas?')) {
                await deleteFromFirebase('openGraves', graveId);
                openGraves = openGraves.filter(g => g.id !== graveId);
                showSuccess('Sepultura removida da lista!');
                updateOpenGravesManagement();
                updateBurialForm();
                updateDashboard();
            }
        }

        async function extendGraveDeadline(graveId) {
            const years = prompt('Quantos anos a mais? (1, 2, 3 ou mais)', '1');
            if (years && !isNaN(years) && years > 0) {
                const grave = openGraves.find(g => g.id === graveId);
                if (grave) {
                    grave.prorrogacao = (grave.prorrogacao || 0) + parseInt(years);
                    grave.ultimaProrrogacao = new Date().toLocaleDateString('pt-BR');
                    await updateFirebase('openGraves', graveId, { 
                        prorrogacao: grave.prorrogacao, 
                        ultimaProrrogacao: grave.ultimaProrrogacao 
                    });
                    showSuccess(`Prazo prorrogado por ${years} ano(s) para a sepultura ${graveId}`);
                    updateOpenGravesManagement();
                }
            }
        }

        function printAllOpenGraves() {
            if (openGraves.length === 0) {
                alert('Nenhuma sepultura aberta para imprimir!');
                return;
            }
            
            const printContent = `
                <div class="print-only">
                    <h1 style="text-align: center; margin-bottom: 20px;">Lista de Sepulturas Abertas</h1>
                    <p style="text-align: center; margin-bottom: 30px;">Data: ${new Date().toLocaleDateString('pt-BR')} - Total: ${openGraves.length} sepultura(s)</p>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f3f4f6;">
                                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 12%;">Data Exumação</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 8%;">Quadra</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 8%;">Lote</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 20%;">Agente</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 17%;">Destino</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 35%;">Fechamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${openGraves.map(grave => {
                                // Find the exhumation that created this open grave
                                const relatedExhumation = exhumations.find(ex => 
                                    ex.quadra === grave.quadra && ex.lote === grave.lote && ex.status === 'concluída'
                                );
                                
                                const dataExumacao = relatedExhumation ? relatedExhumation.dataExumacao : '-';
                                const agente = relatedExhumation ? relatedExhumation.agenteSepultador || '-' : '-';
                                const destino = relatedExhumation ? relatedExhumation.destino || '-' : '-';
                                
                                return {
                                    grave,
                                    dataExumacao,
                                    agente,
                                    destino,
                                    sortDate: relatedExhumation ? new Date(relatedExhumation.dataExumacao) : new Date('1900-01-01')
                                };
                            }).sort((a, b) => a.sortDate - b.sortDate).map(item => {
                                const dataFormatted = item.dataExumacao !== '-' ? new Date(item.dataExumacao + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
                                
                                return `
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px;">${dataFormatted}</td>
                                    <td style="border: 1px solid #000; padding: 8px;">${item.grave.quadra}</td>
                                    <td style="border: 1px solid #000; padding: 8px;">${item.grave.lote}</td>
                                    <td style="border: 1px solid #000; padding: 8px;">${item.agente}</td>
                                    <td style="border: 1px solid #000; padding: 8px;">${item.destino}</td>
                                    <td style="border: 1px solid #000; padding: 20px; height: 40px;"></td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Lista de Sepulturas Abertas</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: top; }
                            th { background-color: #f2f2f2; font-weight: bold; }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Print functions
        function printOpenGraves() {
            const printContent = `
                <div class="print-only">
                    <h1 style="text-align: center; margin-bottom: 20px;">Lista de Sepulturas Abertas</h1>
                    <p style="text-align: center; margin-bottom: 30px;">Data: ${new Date().toLocaleDateString('pt-BR')}</p>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f3f4f6;">
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Quadra</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Lote</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Data Abertura</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Origem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${openGraves.map(grave => `
                                <tr>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${grave.quadra}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${grave.lote}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${grave.dataAbertura}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${grave.origem}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top: 30px; text-align: center;">Total: ${openGraves.length} sepultura(s) aberta(s)</p>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Lista de Sepulturas Abertas</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printBurialsByDate() {
            const selectedDate = document.getElementById('burialCalendarDate').value;
            if (!selectedDate) {
                alert('Selecione uma data primeiro!');
                return;
            }
            
            const dayBurials = burials.filter(burial => burial.data === selectedDate);
            
            if (dayBurials.length === 0) {
                alert('Nenhum sepultamento encontrado para esta data!');
                return;
            }
            
            // Sort by time
            dayBurials.sort((a, b) => {
                const timeA = a.horario || '00:00';
                const timeB = b.horario || '00:00';
                return timeA.localeCompare(timeB);
            });
            
            // Format the selected date properly for display
            const selectedDateFormatted = new Date(selectedDate + 'T00:00:00').toLocaleDateString('pt-BR');
            
            const printContent = `
                <div class="print-only">
                    <h1 style="text-align: center; margin-bottom: 20px;">Sepultamentos do Dia</h1>
                    <p style="text-align: center; margin-bottom: 30px;">Data: ${selectedDateFormatted}</p>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f3f4f6;">
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Velório</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Horário</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Nome do Falecido</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Quadra</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Lote</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Agentes Sepultadores</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dayBurials.map(burial => `
                                <tr>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${burial.velorio || '-'}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${burial.horario}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${burial.nomefalecido}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${burial.quadra}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${burial.lote}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 8px;">${burial.agentes && burial.agentes.length > 0 ? burial.agentes.join(', ') : 'Não definido'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top: 30px; text-align: center;">Total: ${dayBurials.length} sepultamento(s) para ${selectedDateFormatted}</p>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Sepultamentos do Dia - ${selectedDateFormatted}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printExhumationsByDate() {
            const selectedDate = document.getElementById('calendarDate').value;
            if (!selectedDate) {
                alert('Selecione uma data primeiro!');
                return;
            }
            
            const dayExhumations = exhumations.filter(ex => ex.dataExumacao === selectedDate);
            
            if (dayExhumations.length === 0) {
                alert('Nenhuma exumação encontrada para esta data!');
                return;
            }
            
            // Format the selected date properly for display
            const selectedDateFormatted = new Date(selectedDate + 'T00:00:00').toLocaleDateString('pt-BR');
            
            // Group exhumations by agent
            const exhumationsByAgent = {};
            dayExhumations.forEach(ex => {
                const agent = ex.agenteSepultador || 'Não definido';
                if (!exhumationsByAgent[agent]) {
                    exhumationsByAgent[agent] = [];
                }
                exhumationsByAgent[agent].push(ex);
            });
            
            // Generate content grouped by agent
            let agentSections = '';
            Object.entries(exhumationsByAgent).forEach(([agent, exhumations]) => {
                // Header with black background and white text
                agentSections += `
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 0;">
                        <thead>
                            <tr style="background-color: #000000; color: #ffffff;">
                                <th style="border: 1px solid #000; padding: 12px; text-align: left; font-weight: bold;">Quadra</th>
                                <th style="border: 1px solid #000; padding: 12px; text-align: left; font-weight: bold;">Lote</th>
                                <th style="border: 1px solid #000; padding: 12px; text-align: left; font-weight: bold;">Nome do Falecido</th>
                                <th style="border: 1px solid #000; padding: 12px; text-align: left; font-weight: bold;">Agente Sepultador</th>
                                <th style="border: 1px solid #000; padding: 12px; text-align: left; font-weight: bold;">Destino</th>
                                <th style="border: 1px solid #000; padding: 12px; text-align: left; font-weight: bold;">Data da Exumação</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Data rows with white background and black text
                exhumations.forEach(ex => {
                    // Build destination info with additional details
                    let destinoInfo = ex.destino;
                    if (ex.destino === 'sepultura' && ex.quadraDestino && ex.loteDestino) {
                        destinoInfo += ` (Q${ex.quadraDestino} L${ex.loteDestino})`;
                    } else if (ex.destino === 'nicho' && ex.numeroNicho) {
                        destinoInfo += ` (${ex.numeroNicho})`;
                    } else if (ex.destino === 'sepulcro' && ex.quadraSepulcro && ex.numeroSepulcro) {
                        destinoInfo += ` (Q${ex.quadraSepulcro} N${ex.numeroSepulcro})`;
                    } else if (ex.destino === 'traslado' && ex.destinoTraslado) {
                        destinoInfo += ` (${ex.destinoTraslado})`;
                    } else if ((ex.destino === 'traslado-crematório' || ex.destino === 'traslado') && ex.protocolo) {
                        destinoInfo += ` (Prot: ${ex.protocolo})`;
                    }
                    
                    agentSections += `
                        <tr style="background-color: #ffffff; color: #000000;">
                            <td style="border: 1px solid #ddd; padding: 12px;">${ex.quadra}</td>
                            <td style="border: 1px solid #ddd; padding: 12px;">${ex.lote}</td>
                            <td style="border: 1px solid #ddd; padding: 12px;">${ex.nomefalecido}</td>
                            <td style="border: 1px solid #ddd; padding: 12px;">${agent}</td>
                            <td style="border: 1px solid #ddd; padding: 12px;">${destinoInfo}</td>
                            <td style="border: 1px solid #ddd; padding: 12px;">${selectedDateFormatted}</td>
                        </tr>
                    `;
                });
                
                agentSections += `
                        </tbody>
                    </table>
                    <div style="margin-bottom: 30px;"></div>
                `;
            });
            
            const printContent = `
                <div class="print-only">
                    <h1 style="text-align: center; margin-bottom: 20px; font-size: 24px; font-weight: bold;">Exumações do Dia</h1>
                    <p style="text-align: center; margin-bottom: 40px; font-size: 16px;">Data: ${selectedDateFormatted}</p>
                    
                    ${agentSections}
                    
                    <p style="margin-top: 30px; text-align: center; font-size: 14px;">Total: ${dayExhumations.length} exumação(ões) agendada(s) para ${selectedDateFormatted}</p>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Exumações do Dia - ${selectedDateFormatted}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                line-height: 1.4;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin-bottom: 0;
                            }
                            th, td { 
                                border: 1px solid #ddd; 
                                padding: 12px; 
                                text-align: left; 
                                vertical-align: top;
                            }
                            th { 
                                background-color: #000000 !important; 
                                color: #ffffff !important; 
                                font-weight: bold;
                            }
                            td {
                                background-color: #ffffff !important;
                                color: #000000 !important;
                            }
                            @media print {
                                th { 
                                    background-color: #000000 !important; 
                                    color: #ffffff !important; 
                                    -webkit-print-color-adjust: exact;
                                    print-color-adjust: exact;
                                }
                                td {
                                    background-color: #ffffff !important;
                                    color: #000000 !important;
                                }
                            }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-6 right-6 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-8 py-4 rounded-2xl shadow-2xl z-50 transform translate-x-full transition-all duration-500 ease-out';
            successDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                        <span class="text-lg">✅</span>
                    </div>
                    <div>
                        <div class="font-semibold">Sucesso!</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            // Animate in
            setTimeout(() => {
                successDiv.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                successDiv.classList.add('translate-x-full');
                setTimeout(() => successDiv.remove(), 500);
            }, 4000);
        }

        // Dark mode toggle
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
            }
            
            // Force a repaint to ensure styles are applied
            setTimeout(() => {
                document.body.style.display = 'none';
                document.body.offsetHeight; // Trigger reflow
                document.body.style.display = '';
            }, 10);
        }

        // Initialize dark mode
        function initializeDarkMode() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedMode === 'true' || (savedMode === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        }

        // Agent details modal
        function viewAgentDetails(agentName) {
            const agent = agents.find(a => a.nome === agentName);
            if (!agent) return;
            
            const agentExhumations = exhumations.filter(ex => ex.agenteSepultador === agentName);
            const agentBurials = burials.filter(burial => burial.agentes && burial.agentes.includes(agentName));
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Detalhes do Agente</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-2xl">×</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Informações Pessoais</h4>
                            <div class="space-y-3">
                                <p><strong>Nome:</strong> ${agent.nome}</p>
                                <p><strong>RGF:</strong> ${agent.rgf}</p>
                                <p><strong>Telefone:</strong> ${agent.telefone}</p>
                            </div>
                            
                            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4 mt-6">Estatísticas</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center p-3 bg-teal-50 dark:bg-teal-900/20 rounded-lg">
                                    <div class="text-2xl font-bold text-teal-600 dark:text-teal-400">${agentExhumations.length}</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Exumações</div>
                                </div>
                                <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${agentBurials.length}</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Sepultamentos</div>
                                </div>
                                <div class="text-center p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg">
                                    <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${agentExhumations.length + agentBurials.length}</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Total</div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Trabalhos Recentes</h4>
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${[...agentExhumations.map(ex => ({
                                    type: 'Exumação',
                                    date: ex.dataExumacao,
                                    description: `${ex.nomefalecido} - Q${ex.quadra} L${ex.lote}`,
                                    color: 'teal'
                                })), ...agentBurials.map(burial => ({
                                    type: 'Sepultamento',
                                    date: burial.data,
                                    description: `${burial.nomefalecido} - Q${burial.quadra} L${burial.lote}`,
                                    color: 'purple'
                                }))].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10).map(work => `
                                    <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-700 rounded">
                                        <div>
                                            <span class="text-sm font-medium text-${work.color}-600 dark:text-${work.color}-400">${work.type}</span>
                                            <p class="text-xs text-slate-600 dark:text-slate-400">${work.description}</p>
                                        </div>
                                        <span class="text-xs text-slate-500 dark:text-slate-400">${new Date(work.date).toLocaleDateString('pt-BR')}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Monthly ranking functions
        function populateMonthSelector() {
            const selector = document.getElementById('monthSelector');
            if (!selector) return;
            
            const months = new Set();
            
            // Get months from exhumations
            exhumations.forEach(ex => {
                if (ex.dataExumacao) {
                    const date = new Date(ex.dataExumacao);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months.add(monthKey);
                }
            });
            
            // Get months from burials
            burials.forEach(burial => {
                if (burial.data) {
                    const date = new Date(burial.data);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months.add(monthKey);
                }
            });
            
            const sortedMonths = Array.from(months).sort().reverse();
            
            selector.innerHTML = '<option value="">Selecione um mês</option>' +
                sortedMonths.map(month => {
                    const [year, monthNum] = month.split('-');
                    const monthName = new Date(year, monthNum - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    return `<option value="${month}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</option>`;
                }).join('');
        }

        function updateMonthlyRanking() {
            const selectedMonth = document.getElementById('monthSelector').value;
            const container = document.getElementById('monthlyRanking');
            
            if (!selectedMonth) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl opacity-50">🏆</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-lg">Selecione um mês para ver o ranking</p>
                        <p class="text-slate-400 dark:text-slate-500 text-sm mt-2">O ranking será baseado no total de trabalhos realizados</p>
                    </div>
                `;
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            
            // Filter exhumations and burials for the selected month
            const monthExhumations = exhumations.filter(ex => {
                if (!ex.dataExumacao) return false;
                const date = new Date(ex.dataExumacao);
                return date.getFullYear() == year && (date.getMonth() + 1) == month;
            });
            
            const monthBurials = burials.filter(burial => {
                if (!burial.data) return false;
                const date = new Date(burial.data);
                return date.getFullYear() == year && (date.getMonth() + 1) == month;
            });
            
            // Calculate agent statistics for the month
            const agentStats = {};
            
            // Count exhumations
            monthExhumations.forEach(ex => {
                if (ex.agenteSepultador) {
                    if (!agentStats[ex.agenteSepultador]) {
                        agentStats[ex.agenteSepultador] = { exhumations: 0, burials: 0, total: 0 };
                    }
                    agentStats[ex.agenteSepultador].exhumations++;
                    agentStats[ex.agenteSepultador].total++;
                }
            });
            
            // Count burials
            monthBurials.forEach(burial => {
                if (burial.agentes && burial.agentes.length > 0) {
                    burial.agentes.forEach(agentName => {
                        if (!agentStats[agentName]) {
                            agentStats[agentName] = { exhumations: 0, burials: 0, total: 0 };
                        }
                        agentStats[agentName].burials++;
                        agentStats[agentName].total++;
                    });
                }
            });
            
            // Convert to array and sort by total
            const rankedAgents = Object.entries(agentStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.total - a.total);
            
            if (rankedAgents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl opacity-50">📅</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum trabalho registrado neste mês</p>
                        <p class="text-slate-400 dark:text-slate-500 text-sm mt-2">Selecione outro mês ou registre novos trabalhos</p>
                    </div>
                `;
                return;
            }
            
            const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            container.innerHTML = `
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">
                        Ranking de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}
                    </h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">
                        Total de ${monthExhumations.length} exumações e ${monthBurials.length} sepultamentos
                    </p>
                </div>
                
                <div class="space-y-4">
                    ${rankedAgents.map((agent, index) => {
                        const medalEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏅';
                        const bgColor = index === 0 ? 'from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20' : 
                                       index === 1 ? 'from-gray-50 to-gray-100 dark:from-gray-800/20 dark:to-gray-700/20' :
                                       index === 2 ? 'from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20' :
                                       'from-slate-50 to-slate-100 dark:from-slate-800/20 dark:to-slate-700/20';
                        
                        return `
                            <div class="bg-gradient-to-r ${bgColor} rounded-2xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-16 h-16 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-2xl flex items-center justify-center text-2xl">
                                            ${medalEmoji}
                                        </div>
                                        <div>
                                            <h5 class="text-xl font-bold text-slate-800 dark:text-slate-200">${index + 1}º ${agent.name}</h5>
                                            <p class="text-sm text-slate-600 dark:text-slate-400">
                                                ${agent.exhumations} exumações • ${agent.burials} sepultamentos
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-3xl font-bold text-slate-800 dark:text-slate-200">${agent.total}</div>
                                        <div class="text-sm text-slate-500 dark:text-slate-400">trabalhos</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function printMonthlyRanking() {
            const selectedMonth = document.getElementById('monthSelector').value;
            if (!selectedMonth) {
                alert('Selecione um mês primeiro!');
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            // Get the ranking data (reuse the logic from updateMonthlyRanking)
            const monthExhumations = exhumations.filter(ex => {
                if (!ex.dataExumacao) return false;
                const date = new Date(ex.dataExumacao);
                return date.getFullYear() == year && (date.getMonth() + 1) == month;
            });
            
            const monthBurials = burials.filter(burial => {
                if (!burial.data) return false;
                const date = new Date(burial.data);
                return date.getFullYear() == year && (date.getMonth() + 1) == month;
            });
            
            const agentStats = {};
            
            monthExhumations.forEach(ex => {
                if (ex.agenteSepultador) {
                    if (!agentStats[ex.agenteSepultador]) {
                        agentStats[ex.agenteSepultador] = { exhumations: 0, burials: 0, total: 0 };
                    }
                    agentStats[ex.agenteSepultador].exhumations++;
                    agentStats[ex.agenteSepultador].total++;
                }
            });
            
            monthBurials.forEach(burial => {
                if (burial.agentes && burial.agentes.length > 0) {
                    burial.agentes.forEach(agentName => {
                        if (!agentStats[agentName]) {
                            agentStats[agentName] = { exhumations: 0, burials: 0, total: 0 };
                        }
                        agentStats[agentName].burials++;
                        agentStats[agentName].total++;
                    });
                }
            });
            
            const rankedAgents = Object.entries(agentStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.total - a.total);
            
            if (rankedAgents.length === 0) {
                alert('Nenhum trabalho registrado neste mês!');
                return;
            }
            
            const printContent = `
                <div class="print-only">
                    <h1 style="text-align: center; margin-bottom: 20px;">Ranking Mensal dos Agentes</h1>
                    <p style="text-align: center; margin-bottom: 30px;">
                        ${monthName.charAt(0).toUpperCase() + monthName.slice(1)} - 
                        ${monthExhumations.length} exumações e ${monthBurials.length} sepultamentos
                    </p>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f3f4f6;">
                                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: left;">Posição</th>
                                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: left;">Nome do Agente</th>
                                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">Exumações</th>
                                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">Sepultamentos</th>
                                <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankedAgents.map((agent, index) => `
                                <tr>
                                    <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center; font-weight: bold;">${index + 1}º</td>
                                    <td style="border: 1px solid #d1d5db; padding: 12px;">${agent.name}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">${agent.exhumations}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">${agent.burials}</td>
                                    <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center; font-weight: bold;">${agent.total}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top: 30px; text-align: center;">
                        Relatório gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}
                    </p>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Ranking Mensal - ${monthName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            th { background-color: #f2f2f2; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Monthly statistics functions
        function populateDashboardMonthSelector() {
            const selector = document.getElementById('dashboardMonthSelector');
            if (!selector) return;
            
            const months = new Set();
            
            // Get months from exhumations
            exhumations.forEach(ex => {
                if (ex.dataExumacao) {
                    const date = new Date(ex.dataExumacao);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months.add(monthKey);
                }
            });
            
            // Get months from burials
            burials.forEach(burial => {
                if (burial.data) {
                    const date = new Date(burial.data);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months.add(monthKey);
                }
            });
            
            const sortedMonths = Array.from(months).sort().reverse();
            
            selector.innerHTML = '<option value="">Selecione um mês</option>' +
                sortedMonths.map(month => {
                    const [year, monthNum] = month.split('-');
                    const monthName = new Date(year, monthNum - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    return `<option value="${month}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</option>`;
                }).join('');
        }

        function updateMonthlyStats() {
            const selectedMonth = document.getElementById('dashboardMonthSelector').value;
            const container = document.getElementById('monthlyStatsContent');
            
            if (!selectedMonth) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl opacity-50">📅</span>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-lg">Selecione um mês para ver as estatísticas</p>
                        <p class="text-slate-400 dark:text-slate-500 text-sm mt-2">Dados de exumações, sepultamentos e funerárias</p>
                    </div>
                `;
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            
            // Filter exhumations for the selected month
            const monthExhumations = exhumations.filter(ex => {
                if (!ex.dataExumacao) return false;
                const date = new Date(ex.dataExumacao);
                return date.getFullYear() == year && (date.getMonth() + 1) == month;
            });
            
            // Filter burials for the selected month
            const monthBurials = burials.filter(burial => {
                if (!burial.data) return false;
                const date = new Date(burial.data);
                return date.getFullYear() == year && (date.getMonth() + 1) == month;
            });
            
            // Count funeral home participations
            const funeralHomeStats = {};
            monthBurials.forEach(burial => {
                if (burial.funeraria) {
                    funeralHomeStats[burial.funeraria] = (funeralHomeStats[burial.funeraria] || 0) + 1;
                }
            });
            
            // Sort funeral homes by participation count
            const sortedFuneralHomes = Object.entries(funeralHomeStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Top 10
            
            const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            container.innerHTML = `
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-6">
                        Resumo de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}
                    </h3>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-teal-50 to-teal-100 dark:from-teal-900/20 dark:to-teal-800/20 rounded-2xl p-6 border border-teal-200/50 dark:border-teal-700/50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-3xl font-bold text-teal-600 dark:text-teal-400">${monthExhumations.length}</div>
                                    <div class="text-sm font-medium text-teal-700 dark:text-teal-300 uppercase tracking-wide">Exumações</div>
                                </div>
                                <div class="w-16 h-16 bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl flex items-center justify-center">
                                    <span class="text-3xl">📋</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-2xl p-6 border border-purple-200/50 dark:border-purple-700/50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-3xl font-bold text-purple-600 dark:text-purple-400">${monthBurials.length}</div>
                                    <div class="text-sm font-medium text-purple-700 dark:text-purple-300 uppercase tracking-wide">Sepultamentos</div>
                                </div>
                                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center">
                                    <span class="text-3xl">⚰️</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Funeral Homes Ranking -->
                    ${sortedFuneralHomes.length > 0 ? `
                        <div class="bg-gradient-to-br from-rose-50 to-rose-100 dark:from-rose-900/20 dark:to-rose-800/20 rounded-2xl p-6 border border-rose-200/50 dark:border-rose-700/50">
                            <h4 class="text-lg font-bold text-rose-800 dark:text-rose-200 mb-4 flex items-center">
                                <span class="mr-2">🏢</span>
                                Participações das Funerárias
                            </h4>
                            <div class="space-y-3">
                                ${sortedFuneralHomes.map(([name, count], index) => {
                                    const percentage = Math.round((count / monthBurials.length) * 100);
                                    const medalEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏅';
                                    
                                    return `
                                        <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-xl">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-lg">${medalEmoji}</span>
                                                <div>
                                                    <div class="font-semibold text-slate-800 dark:text-slate-200">${name}</div>
                                                    <div class="text-sm text-slate-600 dark:text-slate-400">${percentage}% do total</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-2xl font-bold text-rose-600 dark:text-rose-400">${count}</div>
                                                <div class="text-xs text-slate-500 dark:text-slate-400">sepultamentos</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800/20 dark:to-slate-700/20 rounded-2xl p-6 border border-slate-200/50 dark:border-slate-700/50 text-center">
                            <span class="text-4xl opacity-50">🏢</span>
                            <p class="text-slate-500 dark:text-slate-400 mt-2">Nenhuma participação de funerária registrada neste mês</p>
                        </div>
                    `}
                </div>
            `;
        }

        function printMonthlyStats() {
            const selectedMonth = document.getElementById('dashboardMonthSelector').value;
            if (!selectedMonth) {
                alert('Selecione um mês primeiro!');
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            // Get the statistics data
            const monthExhumations = exhumations.filter(ex => {
                if (!ex.dataExumacao) return false;
                const date = new Date(ex.dataExumacao);
                return date.getFullYear() == year && (date.getMonth() + 1) == month;
            });
            
            const monthBurials = burials.filter(burial => {
                if (!burial.data) return false;
                const date = new Date(burial.data);
                return date.getFullYear() == year && (date.getMonth() + 1) == month;
            });
            
            const funeralHomeStats = {};
            monthBurials.forEach(burial => {
                if (burial.funeraria) {
                    funeralHomeStats[burial.funeraria] = (funeralHomeStats[burial.funeraria] || 0) + 1;
                }
            });
            
            const sortedFuneralHomes = Object.entries(funeralHomeStats)
                .sort(([,a], [,b]) => b - a);
            
            const printContent = `
                <div class="print-only">
                    <h1 style="text-align: center; margin-bottom: 20px;">Estatísticas Mensais</h1>
                    <p style="text-align: center; margin-bottom: 30px;">
                        ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}
                    </p>
                    
                    <div style="margin-bottom: 30px;">
                        <h2 style="margin-bottom: 15px;">Resumo Geral</h2>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 12px; background-color: #f9f9f9; font-weight: bold;">Exumações</td>
                                <td style="border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 18px; font-weight: bold;">${monthExhumations.length}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 12px; background-color: #f9f9f9; font-weight: bold;">Sepultamentos</td>
                                <td style="border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 18px; font-weight: bold;">${monthBurials.length}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 12px; background-color: #f9f9f9; font-weight: bold;">Total de Atividades</td>
                                <td style="border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 18px; font-weight: bold;">${monthExhumations.length + monthBurials.length}</td>
                            </tr>
                        </table>
                    </div>
                    
                    ${sortedFuneralHomes.length > 0 ? `
                        <div>
                            <h2 style="margin-bottom: 15px;">Participações das Funerárias</h2>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="border: 1px solid #d1d5db; padding: 12px; text-align: left;">Posição</th>
                                        <th style="border: 1px solid #d1d5db; padding: 12px; text-align: left;">Funerária</th>
                                        <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">Sepultamentos</th>
                                        <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">Percentual</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedFuneralHomes.map(([name, count], index) => {
                                        const percentage = Math.round((count / monthBurials.length) * 100);
                                        return `
                                            <tr>
                                                <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center; font-weight: bold;">${index + 1}º</td>
                                                <td style="border: 1px solid #d1d5db; padding: 12px;">${name}</td>
                                                <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center; font-weight: bold;">${count}</td>
                                                <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">${percentage}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    
                    <p style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        Relatório gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}
                    </p>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Estatísticas Mensais - ${monthName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            th { background-color: #f2f2f2; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            h1, h2 { color: #333; }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Sistema já inicializado nos arquivos externos
    </script>
</body>
</html>

